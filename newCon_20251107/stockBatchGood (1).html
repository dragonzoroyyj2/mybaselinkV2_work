<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Import URL */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* ë§¤ìš° ë°ì€ ë°°ê²½ */
            padding: 20px;
            min-height: 100vh; 
            color: #1e293b; /* Slate-800 */
        }
        .container {
            max-width: 1100px;
            margin: auto;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 30px;
        }
        
        /* 1. Analysis Option Cards */
        .option-card {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 8px;
            padding: 16px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        input[type="radio"]:checked + .option-card {
            border-color: #4f46e5; 
            background-color: #eef2ff; 
            font-weight: 600;
        }

        /* 2. Table Styles (Responsive Fix and Sticky Header) */
        .results-table th, .results-table td {
            padding: 12px 16px; 
            text-align: left;
            white-space: nowrap;
            min-width: 100px;
        }
        .results-table th {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 700;
            cursor: default;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .results-table tbody tr {
            border-bottom: 1px solid #f1f5f9; 
            transition: background-color 0.15s;
        }
        .results-table tbody tr:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }

        /* 3. Modal Styles: opacityì™€ pointer-eventsë¡œ ìƒíƒœ ê´€ë¦¬ */
        .modal-show {
            opacity: 1 !important;
            pointer-events: auto !important; /* ëª¨ë‹¬ í™œì„±í™” ì‹œ í´ë¦­ í—ˆìš© */
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content-show {
            transform: scale(1) !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">ğŸ“ˆ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ì„¤ì •</h1>
            <p class="text-gray-500">ì›í•˜ëŠ” ë¶„ì„ ì¡°ê±´ì„ ì„ íƒí•˜ê³  ì‹¤í–‰í•˜ì—¬ ìœ ë§ ì¢…ëª©ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
        </header>

        <!-- Main Card: ì„¤ì •, ë²„íŠ¼, ê·¸ë¦¬ê³  ê²°ê³¼ë¥¼ ëª¨ë‘ í¬í•¨ -->
        <div class="card mb-8">
            <form id="analysisForm">
                
                <!-- 1. ë¶„ì„ ìœ í˜• ì„ íƒ (ë“œë¡­ë‹¤ìš´ ë²„íŠ¼) -->
                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-0 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('analysisTypeContent', this)">
                    <span>1. ë¶„ì„ ìœ í˜• ì„ íƒ</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="analysisTypeContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        
                        <!-- MA ë¶„ì„ ì¹´ë“œ (ê¸°ë³¸ ì„ íƒ ìœ ì§€) -->
                        <label for="maRadio" class="block">
                            <input type="radio" name="analysisType" id="maRadio" value="ma" checked 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-indigo-500">ğŸ“‰</span> ì´ë™í‰ê· ì„ (MA) ë¶„ì„ (Default)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¥ê¸° í•˜ë½ì¶”ì„¸ ì§„í–‰ ì¢…ëª© íƒìƒ‰</p>
                                <div id="maPeriodsContainer" class="ml-0 mt-3 p-3 bg-indigo-100/50 rounded-lg transition-all duration-300">
                                    <h4 class="font-semibold text-indigo-700 mb-2 text-sm">MA ê¸°ê°„ ì„ íƒ (í•˜ë½ë°°ì—´ í™•ì¸):</h4>
                                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                                        <input type="checkbox" name="maPeriods" value="60" id="ma60" checked class="rounded text-indigo-600"> 
                                        <label for="ma60" class="text-sm">60ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="200" id="ma200" checked class="rounded text-indigo-600"> 
                                        <label for="ma200" class="text-sm">200ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="500" id="ma500" checked class="rounded text-indigo-600" disabled> 
                                        <label for="ma500" id="ma500Label" class="text-sm opacity-50">500ì¼ì„ </label>
                                        <span id="ma500Hint" class="text-red-500 text-xs font-semibold">(ìµœì†Œ 3ë…„ í•„ìš”)</span>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <!-- ì´ì¤‘ë°”ë‹¥ ì¹´ë“œ -->
                        <label for="doubleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="doubleBottomRadio" value="double_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“ˆ</span> ì´ì¤‘ë°”ë‹¥ (Wìí˜• íŒ¨í„´)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ê°•ë ¥í•œ ì¶”ì„¸ ë°˜ì „ ì´ˆê¸° ì‹ í˜¸ íƒìƒ‰</p>
                            </div>
                        </label>

                        <!-- ì‚¼ì¤‘ë°”ë‹¥ ì¹´ë“œ -->
                        <label for="tripleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="tripleBottomRadio" value="triple_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“Š</span> ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ë°”ë‹¥ ë‹¤ì§€ê¸°ê°€ ì™„ë£Œëœ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                        <!-- ì»µì•¤í•¸ë“¤ ì¹´ë“œ -->
                        <label for="cupAndHandleRadio" class="block">
                            <input type="radio" name="analysisType" id="cupAndHandleRadio" value="cup_and_handle" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-amber-500">â˜•</span> ì»µì•¤í•¸ë“¤ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ëŒíŒŒ ì§ì „ì˜ ìƒìŠ¹ ìœ ë ¥ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜ (ë“œë¡­ë‹¤ìš´ ë²„íŠ¼) -->
                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('filteringOptionsContent', this)">
                    <span>2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="filteringOptionsContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ì•…ì¬ í•„í„°ë§ ì¹´ë“œ -->
                        <div class="p-4 bg-white rounded-lg border border-red-200 shadow-sm flex items-center">
                            <input type="checkbox" id="excludeNegatives" name="excludeNegatives" 
                                class="mr-3 h-5 w-5 rounded text-red-500 focus:ring-red-400 border-gray-300">
                            <label for="excludeNegatives" class="text-lg text-red-700 font-bold flex-grow">
                                ğŸš¨ ì•…ì¬ ì¢…ëª© ì œì™¸ í•„í„°
                            </label>
                        </div>
                        
                        <!-- ë°ì´í„° ê¸°ê°„ ì„¤ì • ì¹´ë“œ -->
                        <div class="p-4 bg-white rounded-lg border border-blue-200 shadow-sm flex items-center">
                            <span class="mr-3 text-blue-700 font-bold">ğŸ“… ë¶„ì„ ê¸°ê°„:</span>
                            <input type="number" id="dataPeriodYears" value="5" min="1" max="10" 
                                oninput="updateMaCheckboxes()"
                                class="w-16 px-3 py-1 border border-blue-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500">
                            <span class="ml-2 text-blue-800 font-semibold">ë…„ì¹˜ ë°ì´í„°</span>
                        </div>
                    </div>
                </div>

                <!-- 3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì • (ë“œë¡­ë‹¤ìš´ ë²„íŠ¼) -->
                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('topNCountContent', this)">
                    <span>3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì •</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="topNCountContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label for="topNCount" class="text-lg text-gray-700 font-medium mr-4">ìƒìœ„ ì¢…ëª© ê°œìˆ˜ (N):</label>
                        <input type="number" id="topNCount" value="10" min="1" max="50" 
                            class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-center font-bold text-xl">
                        <span class="ml-4 text-gray-500 text-sm">1ì—ì„œ 50 ì‚¬ì´</span>
                    </div>
                </div>

            </form>
            
            <!-- ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼ -->
            <button type="button" onclick="runAnalysis()" id="runAnalysisBtn"
                    class="mt-8 w-full px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°
            </button>
            
            <!-- 4. ë¶„ì„ ê²°ê³¼ (ë“œë¡­ë‹¤ìš´ ë²„íŠ¼) -->
            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('resultsContent', this)">
                <span>4. ë¶„ì„ ê²°ê³¼</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="resultsContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                <div id="resultsContainer" class="relative">
                    <!-- 1. Permanent Table Structure (í•­ìƒ í‘œì‹œë¨) -->
                    <!-- min-h-[120px]ë¥¼ ìœ ì§€í•˜ì—¬ ë¡œë”© ì¤‘ì—ë„ ì˜ì—­ì´ ë„ˆë¬´ ìª¼ê·¸ë¼ë“¤ì§€ ì•Šë„ë¡ í•¨ -->
                    <div id="resultsDisplay" class="p-0 bg-white min-h-[120px]">
                        <!-- Content inserted by renderInitialState() -->
                    </div>
    
                    <!-- 2. Loading Overlay -->
                    <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center hidden transition-opacity duration-300 rounded-xl border-4 border-blue-400 p-8 z-20">
                        <div class="text-4xl animate-spin text-blue-600">âš™ï¸</div>
                        <p class="mt-4 text-xl font-bold text-blue-600">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        <p class="text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

            <!-- 5. ì‹¤ì‹œê°„ ë¡œê·¸ (ë“œë¡­ë‹¤ìš´ ë²„íŠ¼) -->
            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('logContent', this)">
                <span>5. ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="logContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                <div id="logDisplay" class="h-48 bg-gray-800 text-gray-200 p-4 overflow-y-scroll rounded-xl font-mono text-sm border border-gray-700">
                    <!-- Log content inserted by JS -->
                </div>
            </div>
            
        </div>
        <!-- Main Card End -->
    </div>

    <!-- Chart Modal (ë ˆì´ì–´ íŒì—…) -->
    <div id="chartModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        <div id="modalContent" class="modal-content bg-white rounded-xl p-6 sm:p-8 shadow-2xl max-w-5xl w-full h-[95vh] sm:h-[90vh] flex flex-col">
            
            <!-- Modal Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3">
                <h3 id="modalTitle" class="text-xl sm:text-3xl font-bold text-indigo-700 mb-2 sm:mb-0 truncate">ì°¨íŠ¸ ìƒì„¸ ë¶„ì„</h3>
                <div class="flex space-x-2 flex-shrink-0">
                    <button onclick="simulateZoom('out')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” ì¶•ì†Œ
                    </button>
                    <button onclick="simulateZoom('in')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” í™•ëŒ€
                    </button>
                    <button onclick="closeChartModal()" class="px-3 py-1 sm:px-4 sm:py-1 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                        âœ–ï¸ ë‹«ê¸°
                    </button>
                </div>
            </div>

            <!-- Modal Body (Chart Area) -->
            <div class="flex-grow overflow-hidden bg-gray-100 rounded-lg p-2">
                <canvas id="stockChartCanvas" class="w-full h-full"></canvas>
            </div>

            <!-- Modal Footer (Simulated Info) -->
            <div id="chartZoomInfo" class="mt-4 text-center text-gray-500 text-xs sm:text-sm">
                (í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const ALL_STOCKS = [
            'ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'LGì—ì†”', 'NAVER', 'ì¹´ì¹´ì˜¤', 'í˜„ëŒ€ì°¨',
            'POSCOí™€ë”©ìŠ¤', 'KBê¸ˆìœµ', 'ì‹ í•œì§€ì£¼', 'ì…€íŠ¸ë¦¬ì˜¨', 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', 
            'HLB', 'í•˜ì´ë¸Œ', 'JYP Ent.', 'LGì „ì', 'ëŒ€í•œí•­ê³µ', 'ê¸°ì•„', 'ì—ì½”í”„ë¡œ', 'HDí˜„ëŒ€',
            'KT', 'LGí™”í•™', 'í¬ìŠ¤ì½”í“¨ì²˜ì— ', 'SKí…”ë ˆì½¤', 'ì—”ì”¨ì†Œí”„íŠ¸', 'ë„·ë§ˆë¸”', 'í¬ë˜í”„í†¤', 'HMM',
            'ì•„ì‹œì•„ë‚˜í•­ê³µ', 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', 'ìš°ë¦¬ê¸ˆìœµì§€ì£¼', 'LGë””ìŠ¤í”Œë ˆì´', 'ê¸ˆí˜¸ì„ìœ ', 'S-Oil',
            'SKì´ë…¸ë² ì´ì…˜', 'ë¡¯ë°ì¼€ë¯¸ì¹¼', 'ì‚¼ì„±SDI', 'SKC', 'LGì´ë…¸í…', 'ë§Œë„', 'í˜„ëŒ€ë¡œí…œ' // ìŠ¤í¬ë¡¤ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì¶”ê°€ ì¢…ëª©
        ];
        
        let currentChartZoomLevel = 1; 
        let currentChartData = {}; 

        // --- Dropdown Toggle Function ---
        /** ì„¹ì…˜ì„ í† ê¸€í•˜ê³  í™”ì‚´í‘œ ì•„ì´ì½˜ì˜ ë°©í–¥ì„ ë³€ê²½í•©ë‹ˆë‹¤. */
        function toggleSection(contentId, buttonElement) {
            const content = document.getElementById(contentId);
            // Find the chevron icon element (the last span child of the button)
            const chevron = buttonElement.querySelector('span:last-child');
            
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                // Show content
                content.classList.remove('hidden');
                // Change icon to 'up' chevron
                chevron.textContent = 'â–´'; 
                chevron.classList.add('rotate-180');

                // 1ë²ˆ ì„¹ì…˜ì´ ì—´ë¦´ ë•Œë§Œ MA ê¸°ê°„ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
                if (contentId === 'analysisTypeContent') {
                     toggleMaPeriods(true);
                }
            } else {
                // Hide content
                content.classList.add('hidden');
                // Change icon to 'down' chevron
                chevron.textContent = 'â–¾';
                chevron.classList.remove('rotate-180');

                // 1ë²ˆ ì„¹ì…˜ì´ ë‹«í ë•Œ MA ê¸°ê°„ ì»¨í…Œì´ë„ˆë„ ìˆ¨ê¹€
                if (contentId === 'analysisTypeContent') {
                     toggleMaPeriods(false);
                }
            }
        }
        
        /** ì„¹ì…˜ì„ ê°•ì œë¡œ ì—¬ëŠ” í•¨ìˆ˜. (ë¶„ì„ ì‹¤í–‰ ì‹œ í•„ìš”) */
        function forceOpenSection(contentId) {
            const content = document.getElementById(contentId);
            // Assuming the button is the sibling before the content div
            const button = content.previousElementSibling; 
            if (content.classList.contains('hidden')) {
                toggleSection(contentId, button);
            }
        }


        // --- Log Update Function (Critical for Auto-Scrolling) ---
        /** ì‹¤ì‹œê°„ ë¡œê·¸ì°½ì— ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ê³  ìŠ¤í¬ë¡¤ì„ ëê¹Œì§€ ë‚´ë¦½ë‹ˆë‹¤. */
        function updateLog(message) {
            const logDisplay = document.getElementById('logDisplay');
            const logEntry = document.createElement('div');
            
            // ìŠ¤íƒ€ì¼ë§: ì‹œê°„ ì •ë³´ëŠ” íšŒìƒ‰, ë©”ì‹œì§€ëŠ” ë°ì€ ë…¹ìƒ‰
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            logEntry.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="text-green-400">${message}</span>`;
            
            // ì˜¤ë˜ëœ ë¡œê·¸ ì œê±° (ì„±ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ 100ì¤„ ì œí•œ)
            if (logDisplay.children.length > 100) {
                logDisplay.removeChild(logDisplay.firstChild);
            }

            logDisplay.appendChild(logEntry);
            
            // ** ìë™ ìŠ¤í¬ë¡¤ ** (ë¡œê·¸ì°½ì´ ëê¹Œì§€ ë‚´ë ¤ê°€ë„ë¡ ë³´ì¥)
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }


        // --- MA Checkbox Update Logic ---
        function updateMaCheckboxes() {
            const dataPeriodInput = document.getElementById('dataPeriodYears');
            const dataPeriod = parseInt(dataPeriodInput.value, 10);
            
            const ma500 = document.getElementById('ma500');
            const ma500Label = document.getElementById('ma500Label');
            const ma500Hint = document.getElementById('ma500Hint');

            if (dataPeriod < 3) {
                ma500.checked = false;
                ma500.disabled = true;
                ma500Label.classList.add('opacity-50');
                ma500Hint.textContent = `(ìµœì†Œ 3ë…„ í•„ìš”)`;
            } else {
                ma500.disabled = false;
                ma500Label.classList.remove('opacity-50');
                ma500Hint.textContent = '';
                if (document.getElementById('maRadio').checked) {
                     ma500.checked = true; // 3ë…„ ì´ìƒì´ë©´ ìë™ìœ¼ë¡œ ì²´í¬
                }
            }
        }

        function toggleMaPeriods(forceOpen) {
            const maPeriodsContainer = document.getElementById('maPeriodsContainer');
            const maRadio = document.getElementById('maRadio');
            
            // 1ë²ˆ ì„¹ì…˜ì´ ë‹«í˜€ ìˆì„ ë•ŒëŠ” ë¬´ì¡°ê±´ ìˆ¨ê¹€
            const section1Content = document.getElementById('analysisTypeContent');
            if (section1Content && section1Content.classList.contains('hidden')) {
                maPeriodsContainer.style.display = 'none';
                return;
            }

            // forceOpenì´ ëª…ì‹œë˜ì§€ ì•Šì€ ê²½ìš°, ë¼ë””ì˜¤ ë²„íŠ¼ ìƒíƒœì— ë”°ë¼ í† ê¸€
            if (maRadio.checked) {
                maPeriodsContainer.style.display = 'block';
                updateMaCheckboxes(); 
            } else {
                maPeriodsContainer.style.display = 'none';
            }
        }


        // --- Analysis Execution Logic ---

        function runAnalysis() {
            const runAnalysisBtn = document.getElementById('runAnalysisBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // 1. ì˜µì…˜ ìˆ˜ì§‘ ë° ìœ íš¨ì„± ê²€ì‚¬ (ì´ì „ê³¼ ë™ì¼)
            const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
            const excludeNegatives = document.getElementById('excludeNegatives').checked;
            
            const dataPeriodInput = document.getElementById('dataPeriodYears');
            const dataPeriod = parseInt(dataPeriodInput.value, 10);
            if (isNaN(dataPeriod) || dataPeriod < 1 || dataPeriod > 10) {
                alertModal("ë¶„ì„ ë°ì´í„° ê¸°ê°„ì€ 1ë…„ì—ì„œ 10ë…„ ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.", "ì…ë ¥ ì˜¤ë¥˜");
                dataPeriodInput.focus();
                return;
            }

            const topNCountInput = document.getElementById('topNCount');
            const topNCount = parseInt(topNCountInput.value, 10);
            if (isNaN(topNCount) || topNCount < 1 || topNCount > ALL_STOCKS.length) { // maxì„ ì „ì²´ ì¢…ëª© ìˆ˜ë¡œ ë³€ê²½
                alertModal(`ìƒìœ„ ì¢…ëª© ê°œìˆ˜(N)ëŠ” 1ì—ì„œ ${ALL_STOCKS.length} ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.`, "ì…ë ¥ ì˜¤ë¥˜");
                topNCountInput.focus();
                return;
            }

            let maPeriods = [];
            if (analysisType === 'ma') {
                const maCheckboxes = document.querySelectorAll('input[name="maPeriods"]:checked:not(:disabled)');
                maPeriods = Array.from(maCheckboxes).map(cb => cb.value);
                if (maPeriods.length === 0) {
                    alertModal("MA ë¶„ì„ì„ ì„ íƒí–ˆì§€ë§Œ, ì„ íƒëœ ì´ë™í‰ê· ì„  ê¸°ê°„ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "ê²½ê³ ");
                    return;
                }
            }
            
            // 2. UI ë³€ê²½ ë° ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
            runAnalysisBtn.disabled = true;
            runAnalysisBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            runAnalysisBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            runAnalysisBtn.textContent = `â±ï¸ ë¶„ì„ ì‹¤í–‰ ì¤‘...`;

            // ** NEW: ë¶„ì„ ì‹¤í–‰ ì‹œ ê²°ê³¼ì™€ ë¡œê·¸ ì„¹ì…˜ì„ ê°•ì œë¡œ í¼ì¹©ë‹ˆë‹¤. **
            forceOpenSection('resultsContent');
            forceOpenSection('logContent');

            // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
            loadingOverlay.classList.remove('hidden');

            // ** ì´ì „ ê²°ê³¼ê°€ ê¹œë¹¡ì´ê±°ë‚˜ íŠ€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë¡œë”© ì‹œì‘ ì‹œ ë‚´ìš©ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. **
            document.getElementById('resultsDisplay').innerHTML = ''; 
            
            // ë¡œê·¸ ì´ˆê¸°í™” ë° ì‹œì‘ ë©”ì‹œì§€
            document.getElementById('logDisplay').innerHTML = '';
            updateLog(`ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. (ìœ í˜•: ${analysisType.toUpperCase()}, ê¸°ê°„: ${dataPeriod}ë…„)`);

            // 3. ë¹„ë™ê¸° ë¡œê·¸ ë° ê²°ê³¼ ì‹œë®¬ë ˆì´ì…˜
            const SIMULATION_DURATION = 3000;
            const LOG_INTERVAL = 500;
            let timeElapsed = 0;

            const logTimer = setInterval(() => {
                timeElapsed += LOG_INTERVAL;
                
                let message = '';
                if (timeElapsed === LOG_INTERVAL) {
                    message = `[Step 1/5] ${dataPeriod}ë…„ì¹˜ ë°ì´í„° ìœ íš¨ì„± ë° ì „ì²˜ë¦¬ í™•ì¸...`;
                } else if (timeElapsed === 1000) {
                    message = `[Step 2/5] íŒ¨í„´ ì¼ì¹˜ ì•Œê³ ë¦¬ì¦˜ ì‹¤í–‰ ì‹œì‘... (ê³ ì„±ëŠ¥ ì½”ì–´ í• ë‹¹)`;
                } else if (timeElapsed === 1500) {
                    message = `[Step 3/5] ì „ì²´ ${ALL_STOCKS.length}ê°œ ì¢…ëª© ì¤‘ ${Math.floor(ALL_STOCKS.length / 2) + Math.floor(Math.random() * 5)}ê°œ 1ì°¨ í•„í„° í†µê³¼.`;
                } else if (timeElapsed === 2000) {
                    message = `[Step 4/5] 2ì°¨ ì í•©ë„(${analysisType}) ê³„ì‚° ì§„í–‰ ì¤‘...`;
                } else if (timeElapsed === 2500) {
                    message = `[Step 5/5] ê²°ê³¼ ì •ë ¬ ë° ìƒìœ„ ${topNCount}ê°œ ì¢…ëª© í™•ì •.`;
                }

                if (message) {
                    updateLog(message);
                }

                if (timeElapsed >= SIMULATION_DURATION) {
                    clearInterval(logTimer);
                    
                    const result = generateSimulatedResult(analysisType, maPeriods, excludeNegatives, topNCount, dataPeriod);
                    renderResults(result);
                    
                    updateLog(`ë¶„ì„ ì™„ë£Œ! (ì†Œìš” ì‹œê°„: ${SIMULATION_DURATION}ms). ê²°ê³¼ë¥¼ í…Œì´ë¸”ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);

                    // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                    loadingOverlay.classList.add('hidden');

                    // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                    runAnalysisBtn.disabled = false;
                    runAnalysisBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    runAnalysisBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    runAnalysisBtn.textContent = 'ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°';
                }
            }, LOG_INTERVAL);
        }

        /** ì„ íƒëœ ì˜µì…˜ì— ë”°ë¥¸ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ì´ì „ê³¼ ë™ì¼) */
        function generateSimulatedResult(type, periods, excludeNegatives, topN, dataPeriod) {
            let potentialStocks = ALL_STOCKS.map(name => ({ name, score: Math.random() * 100 }));

            potentialStocks.forEach(stock => {
                let baseScore = stock.score;
                
                if (type === 'ma') {
                    if (['HLB', 'JYP Ent.', 'ì¹´ì¹´ì˜¤', 'NAVER'].includes(stock.name)) {
                         baseScore += 35; 
                    } else if (['ì‚¼ì„±ì „ì', 'í˜„ëŒ€ì°¨', 'KBê¸ˆìœµ'].includes(stock.name)) {
                        baseScore -= 30; 
                    }
                } else if (type === 'double_bottom' || type === 'triple_bottom') {
                    if (['NAVER', 'SKí•˜ì´ë‹‰ìŠ¤', 'ì¹´ì¹´ì˜¤', 'LGë””ìŠ¤í”Œë ˆì´'].includes(stock.name)) baseScore += 25;
                } else if (type === 'cup_and_handle') {
                    if (['LGì—ì†”', 'POSCOí™€ë”©ìŠ¤', 'ê¸°ì•„', 'í˜„ëŒ€ë¡œí…œ'].includes(stock.name)) baseScore += 25;
                }

                if (excludeNegatives && type !== 'ma') { 
                    if (['HLB', 'JYP Ent.'].includes(stock.name)) baseScore *= 0.1; 
                }
                
                stock.score = Math.min(100, Math.max(0, baseScore)); 
            });

            potentialStocks.sort((a, b) => b.score - a.score);
            let topStocks = potentialStocks.slice(0, topN);

            let winningStocks = topStocks.map((stock, index) => {
                let reason, statusText;
                let isPositive = stock.score > 70;

                if (type === 'ma') {
                    reason = `MA(${periods.join(',')}) í•˜ë½ë°°ì—´ í™•ì¸ ë° ì¶”ì„¸ ê°•í™”`;
                    isPositive = stock.score > 75; 
                    statusText = 'ê°•í•œ í•˜ë½ì¶”ì„¸';
                } else if (type === 'double_bottom') {
                    reason = `Wìí˜• ë°”ë‹¥ ë‹¤ì§€ê¸° íŒ¨í„´ í™•ì¸`;
                    statusText = 'ë§¤ìˆ˜ ìœ ë§ ì‹ í˜¸';
                } else if (type === 'triple_bottom') {
                    reason = `ì‚¼ì¤‘ ë°”ë‹¥ í˜•ì„± ë° ì§€ì§€ë ¥ ê°•í•¨`;
                    statusText = 'ë§¤ìˆ˜ ìœ ë§ ì‹ í˜¸';
                } else if (type === 'cup_and_handle') {
                    reason = `í•¸ë“¤ êµ¬ê°„ ì§„ì…, ëŒíŒŒ ê¸°ëŒ€`;
                    statusText = 'ë§¤ìˆ˜ ìœ ë§ ì‹ í˜¸';
                }

                return {
                    rank: index + 1,
                    name: stock.name,
                    score: stock.score,
                    isPositive: isPositive,
                    reason: reason,
                    statusText: statusText,
                    period: dataPeriod
                };
            });

            const dataPeriodText = `${dataPeriod}ë…„ì¹˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ`;
            const analysisTitleMap = {
                'ma': 'ì¥ê¸° í•˜ë½ì¶”ì„¸ í™•ì¸ ì¢…ëª© (í•˜ë½ë°°ì—´ ê°•ë„ ìˆœ)',
                'double_bottom': 'ì´ì¤‘ë°”ë‹¥ íŒ¨í„´ ìœ ë§ ì¢…ëª©',
                'triple_bottom': 'ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´ ìœ ë§ ì¢…ëª©',
                'cup_and_handle': 'ì»µì•¤í•¸ë“¤ íŒ¨í„´ ìœ ë§ ì¢…ëª©',
            };

            return {
                title: analysisTitleMap[type] || 'ë¶„ì„ ê²°ê³¼',
                description: `${dataPeriodText} ${analysisTitleMap[type] || 'ë¶„ì„'}ì´ ê°•í•˜ê²Œ í¬ì°©ëœ ìƒìœ„ ${topN}ê°œ ì¢…ëª©ì˜ ë­í‚¹ ê²°ê³¼ì…ë‹ˆë‹¤.`,
                excludeNegatives: excludeNegatives,
                stocks: winningStocks,
                topNRequested: topN,
                isDowntrendSearch: type === 'ma',
            };
        }


        // --- Results Table and Chart Modal Functions ---

        /** ìµœì¢… ê²°ê³¼ë¥¼ UIì— í…Œì´ë¸” í˜•íƒœë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. (í•­ìƒ í•­ëª© êµ¬ì¡° ìœ ì§€) */
        function renderResults(result) {
            const resultsDisplay = document.getElementById('resultsDisplay');

            let tableRowsHtml;
            if (result.stocks.length === 0) {
                // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° 'No Data' ë©”ì‹œì§€ í–‰
                tableRowsHtml = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-xl font-semibold text-gray-400 bg-white/70">
                            ğŸ˜­ ë¶„ì„ ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (No Data)
                        </td>
                    </tr>
                `;
            } else {
                // ë°ì´í„°ê°€ ìˆì„ ê²½ìš° ê²°ê³¼ í–‰ë“¤
                tableRowsHtml = result.stocks.map(stock => {
                    let statusClass;
                    if (result.isDowntrendSearch) {
                        statusClass = stock.isPositive ? 'text-red-600 font-bold' : 'text-gray-600';
                    } else {
                        statusClass = stock.isPositive ? 'text-green-600 font-bold' : 'text-yellow-600';
                    }
                    
                    const scoreText = stock.score.toFixed(2);
                    
                    return `
                        <tr class="hover:bg-indigo-50/50 transition duration-100" 
                            onclick="displayStockChart('${stock.name}', ${stock.period}, '${stock.statusText}', ${stock.score.toFixed(0)})"
                            data-stock-name="${stock.name}">
                            <td class="font-bold text-center text-lg text-indigo-600">${stock.rank}</td>
                            <td class="font-semibold text-gray-800">${stock.name}</td>
                            <td class="text-gray-600">${stock.reason}</td>
                            <td class="font-bold ${statusClass}">${stock.statusText}</td>
                            <td class="font-mono text-right">${scoreText}</td>
                            <td class="text-center text-indigo-500 font-medium">ì°¨íŠ¸ &gt;</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // ê³µí†µ êµ¬ì¡° ì—…ë°ì´íŠ¸ (íƒ€ì´í‹€ ë° ë°°ì§€)
            const filterBadge = result.excludeNegatives 
                ? '<span class="px-3 py-1 bg-red-100 text-red-700 font-bold rounded-full text-sm">ì•…ì¬ í•„í„° ì ìš©</span>'
                : '<span class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-sm">ì•…ì¬ í•„í„° ë¯¸ì ìš©</span>';

            const analysisTitle = result.stocks.length > 0 
                ? result.title 
                : (result.isDowntrendSearch ? 'í•˜ë½ì¶”ì„¸ ì¢…ëª© ê²°ê³¼' : 'íŒ¨í„´ ë¶„ì„ ê²°ê³¼') + ' (í•­ëª©)';

            const analysisTitleColor = result.isDowntrendSearch ? 'text-red-600' : 'text-green-600';
            
            resultsDisplay.innerHTML = `
                <div class="px-4 py-3 bg-indigo-50 rounded-t-xl border-b border-indigo-200 flex flex-wrap justify-between items-center gap-3">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <span class="mr-3 text-2xl">ğŸ†</span> ${analysisTitle}
                    </h2>
                    <div class="flex flex-wrap gap-2">
                        ${filterBadge}
                        <span class="px-3 py-1 bg-indigo-200 text-indigo-700 font-bold rounded-full text-sm">
                            ìƒìœ„ ${result.topNRequested}ê°œ ì¢…ëª©
                        </span>
                    </div>
                </div>
                <p class="px-4 py-4 text-gray-600 border-b border-gray-100 bg-white text-sm">
                    ${result.description}
                </p>
                
                <div class="overflow-x-auto max-h-96"> 
                    <table class="results-table w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="w-12 text-center">ìˆœìœ„</th>
                                <th class="w-32">ì¢…ëª©ëª…</th>
                                <th class="w-auto">ë¶„ì„ ì‚¬ìœ </th>
                                <th class="w-32">í˜„ì¬ ìƒíƒœ</th>
                                <th class="w-16 text-right">ì í•©ë„ ì ìˆ˜</th>
                                <th class="w-20 text-center">ì°¨íŠ¸ ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRowsHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }


        /** ì•± ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
        function renderInitialState() {
            const resultsDisplay = document.getElementById('resultsDisplay');
            resultsDisplay.innerHTML = `
                <div class="px-4 py-10 bg-indigo-50 rounded-xl flex flex-col items-center justify-center border-4 border-dashed border-indigo-200">
                    <span class="text-5xl mb-4">âš™ï¸</span>
                    <h3 class="text-xl font-bold text-gray-700">ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</h3>
                    <p class="text-gray-500 mt-1">ìƒë‹¨ì˜ ì˜µì…˜ì„ ì„ íƒ í›„ 'ë¶„ì„ ì‹¤í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                </div>
            `;
            // MA ê¸°ê°„ ìƒíƒœ ì´ˆê¸°í™” (í•„ìˆ˜)
            updateMaCheckboxes(); 
            toggleMaPeriods(true); 
            
            // ê²°ê³¼ë¥¼ ìˆ¨ê¸°ê³ , 1ë²ˆ ì„¹ì…˜(ë¶„ì„ ìœ í˜•)ì„ í¼ì¹¨
            const resultsContent = document.getElementById('resultsContent');
            const logContent = document.getElementById('logContent');
            const analysisTypeContent = document.getElementById('analysisTypeContent');

            if (!resultsContent.classList.contains('hidden')) {
                toggleSection('resultsContent', resultsContent.previousElementSibling);
            }
            if (!logContent.classList.contains('hidden')) {
                toggleSection('logContent', logContent.previousElementSibling);
            }
            if (analysisTypeContent.classList.contains('hidden')) {
                toggleSection('analysisTypeContent', analysisTypeContent.previousElementSibling);
            }
        }
        
        // ** alert() ëŒ€ì‹  ì‚¬ìš©í•  ëª¨ë‹¬ í•¨ìˆ˜ (ê°„ë‹¨í•œ ë©”ì‹œì§€ ë°•ìŠ¤) **
        function alertModal(message, title = "ì•Œë¦¼") {
             const alertDiv = document.createElement('div');
             alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
             alertDiv.innerHTML = `
                 <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                     <h4 class="text-xl font-bold text-red-600 mb-3">${title}</h4>
                     <p class="text-gray-700 mb-5">${message}</p>
                     <button onclick="this.closest('.fixed').remove()" 
                             class="w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                         í™•ì¸
                     </button>
                 </div>
             `;
             document.body.appendChild(alertDiv);
        }

        // --- Chart Modal and Drawing Logic ---

        /** ì°¨íŠ¸ ëª¨ë‹¬ì„ ë‹«ëŠ” í•¨ìˆ˜ */
        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('modal-show');
            content.classList.remove('modal-content-show');
            
            // ëª¨ë‹¬ ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ë”œë ˆì´ í›„ pointer-events ë¹„í™œì„±í™”
            setTimeout(() => {
                modal.classList.add('pointer-events-none');
            }, 300);
        }

        /** ì°¨íŠ¸ ëª¨ë‹¬ì„ ì—´ê³  ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. */
        function displayStockChart(stockName, dataPeriod, statusText, score) {
            currentChartZoomLevel = 1; // ì¤Œ ë ˆë²¨ ì´ˆê¸°í™”
            
            const modal = document.getElementById('chartModal');
            const content = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');
            
            title.textContent = `${stockName} ìƒì„¸ ì°¨íŠ¸ (ì í•©ë„: ${score}ì )`;
            
            // ëª¨ë‹¬ í‘œì‹œ
            modal.classList.remove('pointer-events-none');
            modal.classList.add('modal-show');
            
            // ëª¨ë‹¬ ì½˜í…ì¸  ì• ë‹ˆë©”ì´ì…˜ í™œì„±í™”
            setTimeout(() => {
                 content.classList.add('modal-content-show');
            }, 10); // ì‘ì€ ë”œë ˆì´ë¥¼ ì£¼ì–´ ì• ë‹ˆë©”ì´ì…˜ ì ìš©

            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„± ë° ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            currentChartData = generateSimulatedChartData(stockName, dataPeriod, statusText);
            drawSimulatedChart(currentChartData);
        }
        
        /** ì°¨íŠ¸ í™•ëŒ€/ì¶•ì†Œ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ìº”ë²„ìŠ¤ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•Šê³  í…ìŠ¤íŠ¸ë§Œ ë³€ê²½) */
        function simulateZoom(action) {
            const zoomInfo = document.getElementById('chartZoomInfo');
            
            if (action === 'in' && currentChartZoomLevel < 3) {
                currentChartZoomLevel++;
            } else if (action === 'out' && currentChartZoomLevel > 1) {
                currentChartZoomLevel--;
            }
            
            let zoomText;
            if (currentChartZoomLevel === 1) zoomText = 'ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„';
            if (currentChartZoomLevel === 2) zoomText = 'ìµœê·¼ 2ë…„ ì§‘ì¤‘ ë²”ìœ„';
            if (currentChartZoomLevel === 3) zoomText = 'ìµœê·¼ 6ê°œì›” ì´ˆë‹¨ê¸° ë²”ìœ„';
            
            zoomInfo.innerHTML = `(í˜„ì¬: <span class="font-bold text-indigo-600">${zoomText}</span>) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            
            // ì¤Œ ë ˆë²¨ì— ë”°ë¼ ì°¨íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ì²™ ì‹œë®¬ë ˆì´ì…˜
            if (currentChartData.stockName) {
                drawSimulatedChart(currentChartData);
            }
        }

        /** ì‹œë®¬ë ˆì´ì…˜ ì°¨íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. */
        function generateSimulatedChartData(stockName, dataPeriod, statusText) {
            const numPoints = 120; // 4ê°œì›”ì¹˜ ë°ì´í„°ë¼ê³  ê°€ì •
            const data = [];
            let price = 50 + Math.random() * 50; 
            
            // íŒ¨í„´ ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ ì¶”ê°€ (ë§¤ìš° ë‹¨ìˆœí™”ë¨)
            let baseVolatility = 1 + Math.random() * 0.5;

            for (let i = 0; i < numPoints; i++) {
                let change = (Math.random() - 0.5) * baseVolatility; 
                
                // W, M íŒ¨í„´ ë“±ì„ ëŒ€ëµì ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
                if (statusText.includes('ë°”ë‹¥')) {
                    // ë°”ë‹¥ ë‹¤ì§€ê¸° íŒ¨í„´ (ì¢ì€ ë²”ìœ„ì—ì„œ íš¡ë³´ ë˜ëŠ” Wì)
                    if (i < numPoints / 2) {
                        change = Math.min(0.5, change);
                    }
                    if (i > numPoints / 2 && i < numPoints * 0.75) {
                        change = Math.max(-0.2, change);
                    }
                } else if (statusText.includes('í•˜ë½ì¶”ì„¸')) {
                    // ì§€ì†ì ì¸ í•˜ë½
                    change -= 0.5;
                }
                
                price += change;
                price = Math.max(10, price); // ìµœì†Œ ê°€ê²© ì œí•œ
                data.push(price);
            }

            return { stockName, data, statusText, dataPeriod };
        }

        /** ìº”ë²„ìŠ¤ì— ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ (Chart.js ë¯¸ì‚¬ìš©) */
        function drawSimulatedChart(chartData) {
            const canvas = document.getElementById('stockChartCanvas');
            const ctx = canvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì¡°ì •
            const container = canvas.closest('.flex-grow');
            canvas.width = container.clientWidth - 4; // Padding 
            canvas.height = container.clientHeight - 4;
            
            const data = chartData.data;
            const width = canvas.width;
            const height = canvas.height;
            const padding = 30;
            const dataLength = data.length;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Calculate scale
            const visibleData = data.slice(Math.max(0, dataLength - Math.floor(dataLength / currentChartZoomLevel)), dataLength);
            const minY = Math.min(...visibleData);
            const maxY = Math.max(...visibleData);
            const range = maxY - minY;
            const xStep = (width - 2 * padding) / (visibleData.length - 1);
            const yScale = (height - 2 * padding) / (range || 1); // rangeê°€ 0ì¼ ê²½ìš° ëŒ€ë¹„

            // Draw background and grid
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            ctx.strokeStyle = '#e2e8f0'; // Gray-200
            ctx.lineWidth = 1;
            
            // Y-axis grid lines (simplified)
            for (let i = 0; i <= 5; i++) {
                const y = padding + (height - 2 * padding) * (i / 5);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                // Y-axis labels
                ctx.fillStyle = '#64748b'; // Slate-500
                ctx.font = '10px Inter';
                const priceLabel = (maxY - (range * (i / 5))).toFixed(2);
                ctx.fillText(priceLabel, 5, y + 3);
            }
            
            // X-axis grid (simplified)
            ctx.strokeStyle = '#cbd5e1'; // Slate-300
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw line chart
            ctx.beginPath();
            // Determine line color based on analysis type for visual context
            if (chartData.statusText.includes('í•˜ë½ì¶”ì„¸')) {
                ctx.strokeStyle = '#dc2626'; // Red-600 (Downtrend)
                ctx.shadowColor = '#fca5a5';
            } else {
                ctx.strokeStyle = '#10b981'; // Green-600 (Uptrend/Reversal)
                ctx.shadowColor = '#6ee7b7';
            }
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 5;


            visibleData.forEach((price, index) => {
                const x = padding + index * xStep;
                const y = height - padding - ((price - minY) * yScale);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;

            // Draw current price dot
            const lastPrice = visibleData[visibleData.length - 1];
            const lastX = padding + (visibleData.length - 1) * xStep;
            const lastY = height - padding - ((lastPrice - minY) * yScale);
            
            ctx.fillStyle = '#4f46e5'; // Indigo-600
            ctx.beginPath();
            ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
            ctx.fill();

            // Pattern Text Overlay (for better simulation feel)
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.font = 'bold 20px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(chartData.statusText, width / 2, height / 2);
        }

        // --- Event Listeners and Initial State ---
        
        // Window resize listener for chart responsiveness (critical)
        window.addEventListener('resize', () => {
            if (document.getElementById('chartModal').classList.contains('modal-show')) {
                 // ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                if (currentChartData.stockName) {
                    drawSimulatedChart(currentChartData);
                }
            }
        });

        // Initialize state on load
        window.onload = renderInitialState;
    </script>
</body>
</html>