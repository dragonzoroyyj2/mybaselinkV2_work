<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>ì£¼ì‹ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ì»¤ìŠ¤í…€ + ëª¨ë‹¬)</title>

  <style>
    /* =======================
       ë¡œë”© ìŠ¤í”¼ë„ˆ
       ======================= */
    #loadingSpinner {
      display: none;
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(255,255,255,0.7);
      z-index: 9999;
      justify-content: center; align-items: center;
    }
    #loadingSpinner .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* =======================
       ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼
       ======================= */
    .modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index:10000; justify-content:center; align-items:center; }
    .elegant-modal { background:#fff; border-radius:8px; max-width:500px; width:90%; padding:1rem; position:relative; }
    .elegant-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .close-btn { cursor:pointer; font-size:1.2rem; }
    .form-group { margin-bottom:0.5rem; display:flex; flex-direction:column; }
    .form-group label { font-weight:bold; margin-bottom:0.2rem; }
    .form-group input, .form-group select, .form-group textarea { padding:0.3rem; font-size:0.9rem; }
    .option-group { display:flex; gap:0.5rem; }
    .modal-footer { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem; }
  </style>
</head>

<body>
<div id="loadingSpinner"><div class="spinner"></div></div>

<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ì£¼ì‹ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ì»¤ìŠ¤í…€ + ëª¨ë‹¬)</h2>

    <!-- =======================
         ê²€ìƒ‰ ë° ë²„íŠ¼ ì˜ì—­
         ======================= -->
    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
        <button id="customFilterBtn" class="btn">ì»¤ìŠ¤í…€ í•„í„°</button>
      </div>
    </div>

    <!-- =======================
         ë¦¬ìŠ¤íŠ¸ ì •ë³´ ë° ì•¡ì…˜ ë²„íŠ¼
         ======================= -->
    <div class="list-info">
      <span id="totalCount">ì´ 0ê±´</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel"><i class="fa-solid fa-file-excel"></i></button>
        <button id="addBtn" class="btn"><i class="fas fa-plus"></i></button>
        <button id="deleteSelectedBtn" class="btn red"><i class="fas fa-trash"></i></button>
      </div>
    </div>

    <!-- =======================
         í…Œì´ë¸”
         ======================= -->
    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" /></th>
          <th>No</th>
          <th>ì¢…ëª©ì½”ë“œ</th>
          <th>íšŒì‚¬ëª…</th>
          <th>ì‹œì¥êµ¬ë¶„</th>
          <th>ì—…ì¢…</th>
          <th>ì¢…ê°€</th>
          <th>ì‹œê°€</th>
          <th>ê³ ê°€</th>
          <th>ì €ê°€</th>
          <th>ê±°ë˜ëŸ‰</th>
          <th>ê¸°ì¤€ì¼</th>
        </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <!-- =======================
         í˜ì´ì§•
         ======================= -->
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- =======================
       ë“±ë¡ ëª¨ë‹¬
       ======================= -->
  <div id="addModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>ë“±ë¡</h3>
        <span class="close-btn" data-close="addModal">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="form-group"><label>ì¢…ëª©ì½”ë“œ</label><input id="modalCode" /></div>
        <div class="form-group"><label>íšŒì‚¬ëª…</label><input id="modalName" /></div>
        <div class="form-group"><label>ì‹œì¥êµ¬ë¶„</label><input id="modalMarket" /></div>
        <div class="form-group"><label>ì—…ì¢…</label><input id="modalDept" /></div>
      </div>
      <div class="modal-footer">
        <button id="saveBtn" class="btn">ì €ì¥</button>
        <button class="btn gray" data-close="addModal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- =======================
       ìƒì„¸ ëª¨ë‹¬
       ======================= -->
  <div id="detailModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>ìƒì„¸ ì •ë³´</h3>
        <span class="close-btn" data-close="detailModal">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="form-group"><label>ID</label><input id="detailId" readonly /></div>
        <div class="form-group"><label>ì¢…ëª©ì½”ë“œ</label><input id="detailCode" readonly /></div>
        <div class="form-group"><label>íšŒì‚¬ëª…</label><input id="detailName" /></div>
        <div class="form-group"><label>ì‹œì¥êµ¬ë¶„</label><input id="detailMarket" /></div>
        <div class="form-group"><label>ì—…ì¢…</label><input id="detailDept" /></div>
      </div>
      <div class="modal-footer">
        <button id="updateBtn" class="btn">ìˆ˜ì •</button>
        <button class="btn gray" data-close="detailModal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- =======================
     í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸
     ======================= -->
<th:block layout:fragment="pageScript">

<!-- =======================
     ê³µí†µ ì•Œë¦¼
     ======================= -->
<script>
if (!window.notify) {
  window.notify = function(type, message) {
    switch(type) {
      case 'success': console.log(`[SUCCESS] ${message}`); break;
      case 'info': console.log(`[INFO] ${message}`); break;
      case 'warning': console.warn(`[WARNING] ${message}`); break;
      case 'error': console.error(`[ERROR] ${message}`); break;
      default: console.log(message);
    }
  };
}
</script>

<script src="/js/commonPagination_op.js"></script>
<script src="/js/commonUnifiedList_opV2.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // =======================
  // ë°˜ì‘í˜• í˜ì´ì§• ê·¸ë£¹ ì‚¬ì´ì¦ˆ
  // =======================
  function getPageGroupSize() {
    const width = window.innerWidth;
    if (width < 480) return 3;
    if (width < 768) return 5;
    if (width < 1024) return 10;
    return 20;
  }

  // =======================
  // UnifiedList ì´ˆê¸°í™” (ë²„íŠ¼ ID ë™ì  ì ìš©, ëª¨ë‹¬, ì €ì¥/ìˆ˜ì •, í˜ì´ì§•)
  // =======================
  const manager = initUnifiedList({
    mode: "server",           // server / client
    pagination: true,
    apiUrl: "/api/stock/list",
    tableBodySelector: "#dataTable",
    paginationSelector: "#pagination",
    searchInputSelector: "#searchInput",
    searchBtnSelector: "#searchBtn",
    addBtnSelector: "#addBtn",
    modalId: "#addModal",
    saveBtnSelector: "#saveBtn",
    closeBtnSelector: "[data-close]",
    checkAllSelector: "#checkAll",
    deleteSelectedBtnSelector: "#deleteSelectedBtn",
    detailModalId: "#detailModal",
    excelBtnSelector: "#excelBtn",
    pageSize: 10,
    pageGroupSize: getPageGroupSize(),
    columns: [
      { key: "id", label: "No" },
      { key: "Code", label: "ì¢…ëª©ì½”ë“œ"},
      { key: "Name", label: "íšŒì‚¬ëª…", isDetailLink: true },
      { key: "Market", label: "ì‹œì¥êµ¬ë¶„" },
      { key: "Dept", label: "ì—…ì¢…" },
      { key: "Close", label: "ì¢…ê°€" },
      { key: "Open", label: "ì‹œê°€" },
      { key: "High", label: "ê³ ê°€" },
      { key: "Low", label: "ì €ê°€" },
      { key: "Volume", label: "ê±°ë˜ëŸ‰" },
      { key: "Date", label: "ê¸°ì¤€ì¼" }
    ],
    buttons: {
      searchInputSelector: "#searchInput",
      searchBtnSelector: "#searchBtn",
      addBtnSelector: "#addBtn",
      saveBtnSelector: "#saveBtn",
      closeBtnSelector: "[data-close]",
      deleteSelectedBtnSelector: "#deleteSelectedBtn",
      checkAllSelector: "#checkAll",
      excelBtnSelector: "#excelBtn"
    },
    enableRowClickDetail: false,
    enableDetailView: true,
    detailViewButtons: { update: "#updateBtn", delete: "#deleteSelectedBtn" }
  });

  // =======================
  // ì»¤ìŠ¤í…€ í•„í„°
  // =======================
  const customFilterBtn = document.getElementById("customFilterBtn");
  if (customFilterBtn) {
    customFilterBtn.addEventListener("click", () => {
      const keyword = prompt("í•„í„° í‚¤ì›Œë“œ ì…ë ¥:");
      if (keyword !== null) manager.loadList(0, 'web', keyword);
    });
  }

  // =======================
  // ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸
  // =======================
  document.getElementById("saveBtn").addEventListener("click", () => {
    const newData = {
      Code: document.getElementById("modalCode").value,
      Name: document.getElementById("modalName").value,
      Market: document.getElementById("modalMarket").value,
      Dept: document.getElementById("modalDept").value
    };
    console.log("ì €ì¥ ë°ì´í„°:", newData);
    manager._closeModal("#addModal");
    window.notify("success", "ìƒˆ í•­ëª© ì €ì¥ ì™„ë£Œ (ì½˜ì†” í™•ì¸)");
    manager.loadList(manager.currentPage);
  });

  // =======================
  // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
  // =======================
  document.getElementById("updateBtn").addEventListener("click", () => {
    const updatedData = {
      Id: document.getElementById("detailId").value,
      Name: document.getElementById("detailName").value,
      Market: document.getElementById("detailMarket").value,
      Dept: document.getElementById("detailDept").value
    };
    console.log("ìˆ˜ì • ë°ì´í„°:", updatedData);
    manager._closeModal("#detailModal");
    window.notify("success", "í•­ëª© ìˆ˜ì • ì™„ë£Œ (ì½˜ì†” í™•ì¸)");
    manager.loadList(manager.currentPage);
  });

  // =======================
  // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ pageGroupSize ì¡°ì •
  // =======================
  window.addEventListener("resize", () => {
    const newSize = getPageGroupSize();
    if (newSize !== manager.pageGroupSize) {
      manager.pageGroupSize = newSize;
      document.dispatchEvent(new Event("resizePagination"));
    }
  });
});
</script>
</th:block>

</body>
</html>
