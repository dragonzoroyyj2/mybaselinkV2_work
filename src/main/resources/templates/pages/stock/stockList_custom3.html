<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>주식 종목 리스트</title>

  <!-- 로딩 스피너 스타일 -->
  <style>
    #loadingSpinner {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(255,255,255,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #loadingSpinner .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Toast 기본 스타일 */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 99999;
    }
    .toast {
      margin-bottom: 8px;
      padding: 10px 15px;
      border-radius: 4px;
      color: #fff;
      opacity: 0.9;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    .toast-success { background-color: #4caf50; }
    .toast-info { background-color: #2196f3; }
    .toast-warning { background-color: #ff9800; }
    .toast-error { background-color: #f44336; }
  </style>
</head>

<body>
<div id="loadingSpinner"><div class="spinner"></div></div>
<div id="toastContainer"></div>

<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 주식 종목 리스트</h2>

    <!-- 검색라인 -->
    <div class="toolbar">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="검색어 입력" />
        <button id="searchBtn" class="btn"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <!-- 총건 + 기능 버튼 -->
    <div class="list-info">
      <span id="totalCount">총 0건</span>
      <div class="action-buttons">
        <button id="excelBtn" class="btn excel" title="엑셀 다운로드"><i class="fa-solid fa-file-excel"></i></button>
        <button id="addBtn" class="btn" title="추가"><i class="fas fa-plus"></i></button>
        <button id="deleteSelectedBtn" class="btn red" title="삭제"><i class="fas fa-trash"></i></button>
      </div>
    </div>

    <!-- 테이블 -->
    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" /></th>
          <th>No</th>
          <th>종목코드</th>
          <th>회사명</th>
          <th>시장구분</th>
          <th>업종</th>
          <th>종가</th>
          <th>시가</th>
          <th>고가</th>
          <th>저가</th>
          <th>거래량</th>
          <th>기준일</th>
        </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <!-- 페이징 -->
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- 등록 모달 -->
  <div id="addModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>서버 등록</h3>
        <span data-close="addModal" class="close-btn">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="form-group"><label>제목</label><input id="titleInput" /></div>
        <div class="form-group"><label>담당자</label><input id="ownerInput" /></div>
        <div class="form-group"><label>서버 종류</label>
          <select id="serverType"><option>웹 서버</option><option>DB 서버</option><option>API 서버</option></select>
        </div>
        <div class="form-group"><label>운영 상태</label>
          <div class="option-group">
            <label><input type="radio" name="status" value="active" checked>운영</label>
            <label><input type="radio" name="status" value="pause">중지</label>
          </div>
        </div>
        <div class="form-group"><label>기능 옵션</label>
          <div class="option-group">
            <label><input type="checkbox">백업 활성화</label>
            <label><input type="checkbox">자동 모니터링</label>
          </div>
        </div>
        <div class="form-group"><label>등록일</label><input type="date" id="regDateInput" /></div>
        <div class="form-group"><label>비고</label><textarea id="noteInput" rows="3"></textarea></div>
      </div>
      <div class="modal-footer elegant-footer">
        <button id="saveBtn" class="btn">저장</button>
        <button class="btn gray" data-close="addModal">닫기</button>
      </div>
    </div>
  </div>

  <!-- 상세 / 수정 모달 -->
  <div id="detailModal" class="modal">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>상세 정보</h3>
        <span data-close="detailModal" class="close-btn">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="form-group"><label>No</label><input id="detailId" readonly /></div>
        <div class="form-group"><label>제목</label><input id="detailTitle" /></div>
        <div class="form-group"><label>담당자</label><input id="detailOwner" /></div>
        <div class="form-group"><label>등록일</label><input id="detailRegDate" readonly /></div>
        <div class="form-group"><label>서버 상태</label>
          <select><option>정상</option><option>점검중</option></select>
        </div>
        <div class="form-group"><label>기능 옵션</label>
          <div class="option-group">
            <label><input type="checkbox">백업 활성화</label>
            <label><input type="checkbox">자동 모니터링</label>
          </div>
        </div>
        <div class="form-group"><label>비고</label><textarea id="detailNote" rows="3"></textarea></div>
      </div>
      <div class="modal-footer elegant-footer">
        <button id="updateBtn" class="btn">수정</button>
        <button class="btn gray" data-close="detailModal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 페이지별 스크립트 -->
<th:block layout:fragment="pageScript">
<script src="/js/commonPagination_op.js"></script>
<script src="/js/commonUnifiedList_opV3.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // =======================
  // Toast/Notify 구현 (실제 운영용)
  // =======================
  if (!window.notify) {
    window.notify = function(type, message) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
      console.log(`[${type.toUpperCase()}] ${message}`);
    };
  }

  // =======================
  // 반응형 페이지 그룹 계산
  // =======================
  function getPageGroupSize() {
    const width = window.innerWidth;
    if (width < 480) return 3;
    if (width < 768) return 5;
    if (width < 1024) return 10;
    return 20;
  }

  let pageGroupSize = getPageGroupSize();

  // =======================
  // 공용 리스트 초기화 (V3)
  // =======================
  const defaultButtons = {
    searchInputSelector: "#searchInput",
    searchBtnSelector: "#searchBtn",
    addBtnSelector: "#addBtn",
    saveBtnSelector: "#saveBtn",
    detailUpdateBtnSelector: "#updateBtn",
    detailDeleteBtnSelector: "#deleteSelectedBtn",
    deleteSelectedBtnSelector: "#deleteSelectedBtn",
    checkAllSelector: "#checkAll",
    excelBtnSelector: "#excelBtn"
  };

  const unifiedListManager = initUnifiedList({
    mode: "server",
    pagination: true,
    apiUrl: "/api/stock/list",
    tableBodySelector: "#dataTable",
    paginationSelector: "#pagination",
    searchInputSelector: defaultButtons.searchInputSelector,
    searchBtnSelector: defaultButtons.searchBtnSelector,
    addBtnSelector: defaultButtons.addBtnSelector,
    saveBtnSelector: defaultButtons.saveBtnSelector,
    deleteSelectedBtnSelector: defaultButtons.deleteSelectedBtnSelector,
    excelBtnSelector: defaultButtons.excelBtnSelector,
    checkAllSelector: defaultButtons.checkAllSelector,
    columns: [
      { key: "id", label: "No" },
      { key: "Code", label: "종목코드" },
      { key: "Name", label: "회사명", isDetailLink: true },
      { key: "Market", label: "시장구분" },
      { key: "Dept", label: "업종" },
      { key: "Close", label: "종가" },
      { key: "Open", label: "시가" },
      { key: "High", label: "고가" },
      { key: "Low", label: "저가" },
      { key: "Volume", label: "거래량" },
      { key: "Date", label: "기준일" }
    ],
    pageSize: 10,
    pageGroupSize: pageGroupSize,
    enableRowClickDetail: true,
    enableDetailView: true,
    detailViewButtons: {
      update: defaultButtons.detailUpdateBtnSelector,
      delete: defaultButtons.detailDeleteBtnSelector
    }
  });
  
  /*
  const addUserBtn = document.getElementById("addUserBtn");
  if (addUserBtn) {
    addUserBtn.addEventListener("click", () => {
      alert("사용자 추가 모달을 여는 커스텀 로직");
      // 사용자 추가 로직 (예: 별도의 API 호출, 특정 폼 초기화 등)
    });
  }

  const customFilterBtn = document.getElementById("customFilterBtn");
  if (customFilterBtn) {
    customFilterBtn.addEventListener("click", () => {
      alert("커스텀 필터링 로직 실행");
      // 필터링 로직 구현 (예: 특정 파라미터를 추가하여 loadList 호출)
    });
  }
  */

  // =======================
  // 화면 리사이즈 시 페이지 그룹 재조정
  // =======================
  window.addEventListener("resize", () => {
    const newGroupSize = getPageGroupSize();
    if (newGroupSize !== pageGroupSize) {
      pageGroupSize = newGroupSize;
      unifiedListManager.pageGroupSize = newGroupSize;
      const event = new Event("resizePagination");
      document.dispatchEvent(event);
    }
  });
});
</script>
</th:block>
</body>
</html>
