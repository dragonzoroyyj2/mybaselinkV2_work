<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter', sans-serif; }
.chart-canvas-wrap{width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;min-height:300px;}
#chartCanvas,#macdCanvas{width:100%;height:360px;}
@media(max-width:640px){#chartCanvas,#macdCanvas{height:260px;}}
.accordion-section { border-bottom: 1px solid #e5e7eb; }
.accordion-header { display:flex;justify-content:space-between;align-items:center;width:100%;padding:1rem 1.25rem;font-size:1.25rem;font-weight:700;cursor:pointer;transition:background-color 0.2s; }
.accordion-header:hover { background-color:#eef2ff; }
/* âœ… ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ ê°œì„  */
.accordion-content {
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transform: scaleY(0.95);
  transform-origin: top;
 transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

}

.accordion-content.open {
  max-height: 1000px; /* ì¶©ë¶„íˆ í° ê°’ (ë‚´ë¶€ ì½˜í…ì¸  ë†’ì´ë³´ë‹¤ í¬ë©´ OK) */
  opacity: 1;
  transform: scaleY(1);
}

/* âœ… íŒ¨í„´ ì¹´ë“œ ì„ íƒ ìƒíƒœ ì‹œê° ê°•í™” */
.option-card-wrapper {
  cursor: pointer;
  transition: all 0.25s ease;
}
.option-card {
  border: 2px solid #d1d5db;
  border-radius: 12px;
  padding: 1rem;
  text-align: center;
  background-color: #fff;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Hover íš¨ê³¼ */
.option-card-wrapper:hover .option-card {
  border-color: #818cf8; /* indigo-400 */
  background-color: #eef2ff;
}

/* âœ… ì„ íƒëœ ìƒíƒœ */
input[type="radio"]:checked + .option-card {
  border-color: #4f46e5; /* indigo-600 */
  background-color: #eef2ff;
  box-shadow: 0 0 8px rgba(79, 70, 229, 0.3);
  transform: scale(1.03);
}

/* âœ… ë¹„ì„ íƒ ìƒíƒœ ì•½ê°„ íˆ¬ëª… */
input[type="radio"]:not(:checked) + .option-card {
  opacity: 0.7;
}


.rotate-icon { transition:transform 0.4s ease; }
.rotate-icon.open { transform:rotate(180deg); }
.status-running { color: #3b82f6; font-weight: bold; }
.status-locked { color: #f59e0b; font-weight: bold; }
.status-completed { color: #22c55e; font-weight: bold; }
.status-failed { color: #ef4444; font-weight: bold; }
.status-cancelled { color: #9ca3af; font-weight: bold; }
.status-idle { color: #6b7280; }
.btn-disabled { opacity:0.5; cursor:not-allowed; }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.5;} }
.status-running.blinking { animation:blink 1s infinite; }



/* íˆ´íŒ ì»¨í…Œì´ë„ˆ (relative) */
.tooltip-container {
    position: relative;
    display: inline-block; /* ì…€ ë‚´ìš©ê³¼ í•¨ê»˜ í‘œì‹œ */
}

/* ì •ë³´ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
.info-icon {
    margin-left: 5px;
    font-size: 0.8em;
    font-weight: bold;
    color: #4f46e5; /* ì¸ë””ê³  ìƒ‰ìƒ */
    cursor: pointer;
}

/* íˆ´íŒ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.tooltip-box {
    visibility: hidden; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    opacity: 0;
    transition: opacity 0.3s;
    width: 200px; /* íˆ´íŒ ë„ˆë¹„ ì„¤ì • */
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 10px;
    position: absolute;
    z-index: 10;
    bottom: 125%; /* ì…€ ìœ„ìª½ì— ìœ„ì¹˜ */
    left: 50%;
    margin-left: -100px; /* ê°€ìš´ë° ì •ë ¬ */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    font-size: 0.85em;
    line-height: 1.4;
    white-space: normal; /* íˆ´íŒ ë‚´ìš© ì¤„ë°”ê¿ˆ í—ˆìš© */
}

/* íˆ´íŒ í™”ì‚´í‘œ (ì„ íƒì‚¬í•­) */
.tooltip-box::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

/* íˆ´íŒ í‘œì‹œ í´ë˜ìŠ¤ */
.tooltip-box.visible {
    visibility: visible;
    opacity: 1;
}

/* â­ ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ì ê¸ˆ (iOS/Android ëŒ€ì‘) - ëª¨ë‹¬ ì—´ë¦´ ë•Œ bodyì— ì¶”ê°€ */
.modal-open-fix {
  overflow: hidden !important; 
  position: fixed; 
  width: 100%;
  height: 100vh;
  top: 0;
  left: 0;
}


/* âœ… ì• ë‹ˆë©”ì´ì…˜ */
@keyframes fadeInUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
/* âœ… ì°¨íŠ¸ ë¡œë”© ìŠ¤í”¼ë„ˆ */
.loader { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
/* âœ… ìŠ¤í¬ë¡¤ ì ê¸ˆìš© */
.modal-open-fix {
  overflow: hidden !important;
  position: fixed;
  width: 100%;
  height: 100vh;
  top: 0; left: 0;
}

/* âœ… ë¸Œë¼ìš°ì €ë³„ ì¤‘ì•™ ì •ë ¬ ë° ìŠ¤ì¼€ì¼ ì•ˆì •í™” */
#chartModal { align-items: center; justify-content: center; }
#chartModal .modal-card { margin: auto; transform: translateY(0); }
</style>
<head>
<!-- ë°˜ë“œì‹œ Chart.jsë³´ë‹¤ ë¨¼ì € -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

</head>
</head>

<body>
<div layout:fragment="content">
<div class="content-container p-4 md:p-6 lg:p-8">

<!-- ğŸ“Œ í—¤ë” -->
	<div class="page-header">
	  <div class="page-title">
	    <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©'">ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©</h2>
	  </div>
	  <div class="breadcrumb">
	    <i class="fas fa-folder-open"></i>
	    <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ'">ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ</span>
	  </div>
	</div>   

<!-- ğŸŒ ì „ì—­ ìƒíƒœ -->
<div class="global-status-card bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-6">
  <div class="flex justify-between items-center mb-2">
    <span class="font-bold text-lg">ğŸŒ AthenaAI ì „ì—­ ë°°ì¹˜ ì§„í–‰ ìƒíƒœ</span>
    <span id="globalStatusText" class="text-gray-500">ëŒ€ê¸°ì¤‘</span>
  </div>
  <div class="flex justify-between text-sm text-gray-600 mb-2">
    <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
    <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
  </div>
  <div class="w-full h-3 bg-gray-200 rounded-lg overflow-hidden">
    <div id="globalProgressBar" class="h-full bg-blue-600 transition-all duration-300" style="width:0%"></div>
  </div>
</div>

<!-- âš™ï¸ ì•„ì½”ë””ì–¸ ì¹´ë“œ -->
<div class="card bg-white border border-gray-200 rounded-xl p-5 mb-10 shadow-sm">
  <form id="analysisForm" class="space-y-4">

    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion('analysisTypeContent', 'icon1')">
        <span>1ï¸âƒ£ ë¶„ì„ ìœ í˜• ì„ íƒ</span>
        <i id="icon1" class="fas fa-chevron-down rotate-icon"></i>
      </div>
      <div id="analysisTypeContent" class="accordion-content open p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" id="maRadio" value="long_term_down_trend" class="hidden" checked onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸ“‰ MA ì¥ê¸° í•˜ë½ ì¶”ì„¸</div>
        </label>
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="double_bottom" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸ“ˆ ì´ì¤‘ë°”ë‹¥</div>
        </label>
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="triple_bottom" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸ“Š ì‚¼ì¤‘ë°”ë‹¥</div>
        </label>
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="cup_and_handle" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">â˜• ì»µì•¤í•¸ë“¤</div>
        </label>
      </div>
    </div>

    <!-- MA ì˜µì…˜ -->
	<div id="maPeriodsContainer" class="bg-indigo-50 rounded-lg p-4 mt-2">
	  <h4 class="font-bold text-indigo-600 mb-2">MA ê¸°ê°„</h4>
	  <div class="flex flex-wrap gap-4 items-center text-sm">
	    <input type="checkbox" id="ma20" value="20" checked disabled class="mr-1">
	    <label for="ma20" class="font-bold">20ì¼ (í•„ìˆ˜)</label>
	
	    <input type="checkbox" id="ma50" name="maPeriods" value="50" checked>
	    <label for="ma50">50ì¼</label>
	
	    <input type="checkbox" id="ma200" name="maPeriods" value="200" checked>
	    <label for="ma200">200ì¼</label>
	  </div>
	</div>


    <!-- 2ï¸âƒ£ ì‹¤í–‰ ì˜µì…˜ + ê²°ê³¼ ê°œìˆ˜ -->
    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion('executionOptionsContent', 'icon2')">
        <span>2ï¸âƒ£ ì‹¤í–‰ ì˜µì…˜</span>
        <i id="icon2" class="fas fa-chevron-down rotate-icon"></i>
      </div>
      <div id="executionOptionsContent" class="accordion-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 bg-gray-50 border rounded-lg flex items-center gap-2">
          <span class="text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì:</span>
          <input id="workerCount" type="number" value="8" min="1" max="16" class="w-20 text-center border rounded-lg">
        </div>
        <div class="p-4 bg-gray-50 border rounded-lg flex items-center gap-2">
          <span class="text-purple-700 font-bold">ğŸ”¢ ìƒìœ„ N:</span>
          <input id="topNCount" type="number" value="10" min="1" max="50" class="w-20 text-center border rounded-lg">
        </div>
      </div>
    </div>

  </form>

  <!-- ì‹¤í–‰/ì·¨ì†Œ ë²„íŠ¼ -->
  <div class="flex flex-col sm:flex-row gap-4 mt-8">
    <button id="runAnalysisBtn" onclick="runAnalysis()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-lg font-bold">ğŸš€ ë¶„ì„ ì‹¤í–‰</button>
    <button id="btnCancel" onclick="cancelAnalysis()" class="flex-1 bg-red-600 text-white py-3 rounded-xl text-lg font-bold" disabled>âŒ ì·¨ì†Œ</button>
  </div>
</div>

<!-- ê²°ê³¼/ë¡œê·¸ ì¹´ë“œ -->
<div class="card bg-white border rounded-xl p-5 mb-10 shadow-sm">
  <h3 class="text-2xl font-bold mb-4">ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
  	<div class="overflow-x-auto">
		  <table class="min-w-full text-sm" id="resultTable">
		    <thead class="bg-gray-100">
		      <tr>
		        <th class="p-3">ìˆœìœ„</th>       
		        <th class="p-3">ì¢…ëª©ì½”ë“œ</th>
		        <th class="p-3">ì¢…ëª©ëª…</th>
		        <th class="p-3">ì‹ í˜¸</th>
		        <th class="p-3">MA ë°°ì—´</th>
		        <th class="p-3">í¬ë¡œìŠ¤ ì—¬ë¶€</th>
		        <th class="p-3">ì°¨íŠ¸</th>
		      </tr>
		    </thead>
		    <tbody id="resultTableBody"></tbody>
		  </table>
	</div>
  
  
  <div id="noResultBox" class="hidden p-6 text-center text-gray-500">ê²°ê³¼ ì—†ìŒ</div>
</div>

<div class="card bg-white border rounded-xl p-5 mb-10 shadow-sm">
  <h3 class="text-2xl font-bold mb-4 flex items-center">
    ğŸªµ ì‹¤ì‹œê°„ ë¡œê·¸
    <button id="copyLogBtn" class="ml-3 text-sm bg-indigo-600 text-white px-3 py-1 rounded-md">ë³µì‚¬</button>
  </h3>
  <div id="logBox" class="h-64 bg-black text-green-300 p-3 overflow-y-auto font-mono text-xs rounded-md"><p>ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p></div>
</div>

<!-- ğŸ“ˆ ì°¨íŠ¸ ëª¨ë‹¬ (ì™„ì „ ë°˜ì‘í˜• ì¤‘ì•™ ì •ë ¬ + ìŠ¤í¬ë¡¤ ë½ + ì• ë‹ˆë©”ì´ì…˜ ì ìš©) -->
<div id="chartModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[9999] p-4">
  <div class="modal-card bg-white rounded-2xl w-full max-w-[95vw] sm:max-w-2xl md:max-w-3xl lg:max-w-5xl max-h-[90vh] overflow-y-auto p-4 relative shadow-2xl animate-[fadeInUp_0.25s_ease-out]">
    <h2 id="modalTitle" class="text-lg sm:text-xl md:text-2xl font-bold mb-4 text-left pl-2 pr-24"></h2>

    <!-- âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="chartLoading" class="hidden absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center z-20">
      <div class="loader border-4 border-t-4 border-gray-200 border-t-indigo-500 rounded-full w-10 h-10 animate-spin"></div>
    </div>

    <!-- âœ… ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
    <div class="chart-canvas-wrap mb-4">
      <canvas id="chartCanvas"></canvas>
    </div>
    <div class="chart-canvas-wrap mb-2">
      <canvas id="macdCanvas"></canvas>
    </div>

    <!-- âœ… ìƒë‹¨ ì œì–´ ë²„íŠ¼ -->
    <div class="absolute top-3 right-3 flex items-center gap-2">
      <button id="btnResetZoom" class="hidden bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
        ğŸ”„ ì¤Œ ì´ˆê¸°í™”
      </button>
      <button id="btnSaveChart" class="hidden bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700 transition">
        ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥
      </button>
      <button onclick="closeChartModal()" class="text-gray-500 hover:text-black text-lg font-bold">âœ–</button>
    </div>
  </div>
</div>


</div>
</div>


<th:block layout:fragment="pageScript">
<script>
/* ==========================================================
 * ğŸ“œ AthenaAI (chart + analyze) í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ (ì™„ì„±íŒ)
 * - Chart.js Financial + Zoom í”ŒëŸ¬ê·¸ì¸ ì•ˆì „ ë“±ë¡
 * - JSON ì°¨íŠ¸ ë Œë”ë§ + ì¤Œ ì´ˆê¸°í™” + ì´ë¯¸ì§€ ì €ì¥(ë©”ì¸+MACD í•©ì„±)
 * - SSE ìƒíƒœ ë™ê¸°í™”, ì‹¤í–‰/ì·¨ì†Œ, ë¡œê·¸/ê²°ê³¼ í…Œì´ë¸”
 * ========================================================== */

/* âœ… ì•„ì½”ë””ì–¸ í† ê¸€ */
window.toggleAccordion = function(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  const isOpen = content.classList.contains('open');

  // ëª¨ë°”ì¼ì—ì„œëŠ” í•˜ë‚˜ë§Œ ì—´ë¦¬ê²Œ
  if (window.innerWidth < 768) {
    document.querySelectorAll('.accordion-content').forEach(c => { if (c !== content) c.classList.remove('open'); });
    document.querySelectorAll('.rotate-icon').forEach(i => { if (i !== icon) i.classList.remove('open'); });
  }

  content.classList.toggle('open', !isOpen);
  icon.classList.toggle('open', !isOpen);
};

(function () {
  /* ================================
     âœ… ìš”ì†Œ ì„ íƒ
  ================================== */
  const $runBtn = document.getElementById("runAnalysisBtn");
  const $cancelBtn = document.getElementById("btnCancel");

  const $analysisForm = document.getElementById("analysisForm");
  const $log = document.getElementById("logBox");
  const $copyLogBtn = document.getElementById("copyLogBtn");

  const $resultTableBody = document.getElementById("resultTableBody");
  const $noResultBox = document.getElementById("noResultBox");

  const $chartModal = document.getElementById("chartModal");
  const $modalTitle = document.getElementById("modalTitle");
  const $btnResetZoom = document.getElementById('btnResetZoom');
  const $btnSaveChart = document.getElementById('btnSaveChart');
  const $chartLoading = document.getElementById('chartLoading');

  const $globalStatusText = document.getElementById("globalStatusText");
  const $globalRunner = document.getElementById("globalRunner");
  const $globalProgressLabel = document.getElementById("globalProgressLabel");
  const $globalProgressBar = document.getElementById("globalProgressBar");

  const $priceCanvas = document.getElementById('chartCanvas');
  const $macdCanvas  = document.getElementById('macdCanvas');

  let priceChart = null;
  let macdChart  = null;

  let currentTaskId = null;
  let es = null;
  let currentUser = "ë¯¸ì—°ê²°";
  let $currentRow = null;
  let globalStatus = "IDLE";

  /* ================================
     âœ… Chart.js Financial + Zoom í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
     - chartjs-plugin-zoom UMD ì „ì—­: ChartZoom
  ================================== */
  (function ensureFinancialRegistered(){
	  try {
	    const hasCandle =
	      (Chart?.registry?.controllers?.get?.('candlestick')) ||
	      (Chart?.controllers && (Chart.controllers.candlestick || Chart.FinancialController));
	    if (!hasCandle) {
	      const candlestick = (Chart.FinancialController || Chart.controllers?.candlestick);
	      const ohlc        = (Chart.OhlcController      || Chart.controllers?.ohlc);
	      if (candlestick) Chart.register(candlestick);
	      if (ohlc)        Chart.register(ohlc);
	    }

	    // âœ… ì¤Œ í”ŒëŸ¬ê·¸ì¸ ê¸€ë¡œë²Œ íƒìƒ‰ & ë“±ë¡ (UMD/Esm/Legacy ëª¨ë‘ í˜¸í™˜)
	    const zoomCandidate = window.ChartZoom || window.chartjsPluginZoom || window.Zoom || window['chartjs-plugin-zoom'];
	    if (zoomCandidate && typeof zoomCandidate.id === 'string') {
	      Chart.register(zoomCandidate);
	      console.info('[ChartJS] Zoom plugin registered:', zoomCandidate.id);
	    } else {
	      console.warn('[ChartJS] Zoom plugin not found on global scope.');
	    }
	  } catch (e) {
	    console.warn('Financial/Zoom register warning:', e);
	  }
	})();



  /* ================================
     âœ… ë¶„ì„ ìœ í˜• & MA
  ================================== */
  function getSelectedPattern() {
    const checked = document.querySelector("input[name='analysisType']:checked");
    return checked ? checked.value : "ma";
  }

  function getMaPeriods() {
    const maPeriodsElements = document.querySelectorAll('input[name="maPeriods"]:checked');
    const maPeriods = Array.from(maPeriodsElements)
      .map(el => el.value)
      .filter((value, index, self) => self.indexOf(value) === index)
      .sort((a, b) => parseInt(a) - parseInt(b))
      .join(',');
    return maPeriods;
  }

  /* ================================
     âœ… MA í‘œì‹œ/ìˆ¨ê¹€
  ================================== */
  window.toggleMaPeriods = function () {
    const isMA = document.getElementById("maRadio").checked;
    const box = document.getElementById("maPeriodsContainer");
    if (!box) return;
    const inputs = box.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(input => {
      if (input.id === 'ma20') return; // 20ì¼ì€ í•„ìˆ˜ + disabled ìœ ì§€
      input.disabled = !isMA;
    });
    box.style.display = isMA ? "block" : "none";
  };

  /* ================================
     âœ… ì„¹ì…˜ í† ê¸€ (í‚¤í”„ë ˆì„ ì• ë‹ˆë©”ì´ì…˜ê³¼ ì¶©ëŒ ì—†ê²Œ)
  ================================== */
  window.toggleSection = function (contentId, buttonElement, arrowId) {
    const content = document.getElementById(contentId);
    const arrow = document.getElementById(arrowId);
    const isClosed = content.style.maxHeight === '0px' || content.style.maxHeight === '';
    if (isClosed) {
      content.style.maxHeight = content.scrollHeight + "px";
      arrow.classList.add('rotate-180');
      setTimeout(() => {
        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
          content.style.maxHeight = null;
        }
      }, 450);
    } else {
      if (content.style.maxHeight === 'none' || content.style.maxHeight === '') {
        content.style.maxHeight = content.scrollHeight + "px";
      }
      arrow.classList.remove('rotate-180');
      void content.offsetWidth;
      requestAnimationFrame(() => {
        content.style.maxHeight = '0px';
      });
    }
  };

  /* ================================
     âœ… ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ì›ë³¸ ìœ ì§€)
  ================================== */
  let dragSrcEl = null;
  function handleDragStart (e) {
    dragSrcEl = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
    this.classList.add('dragging');
  }
  function handleDragOver (e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
  function handleDragEnter () { this.classList.add('drag-over'); }
  function handleDragLeave () { this.classList.remove('drag-over'); }
  function handleDrop (e) {
    e.stopPropagation();
    this.classList.remove('drag-over');
    if (dragSrcEl !== this) {
      const container = document.getElementById("analysisTypeContent");
      if (dragSrcEl.compareDocumentPosition(this) & Node.DOCUMENT_POSITION_FOLLOWING) {
        container.insertBefore(dragSrcEl, this.nextSibling);
      } else {
        container.insertBefore(dragSrcEl, this);
      }
      const sourceRadio = dragSrcEl.querySelector('input[type="radio"]');
      const targetRadio = this.querySelector('input[type="radio"]');
      if (sourceRadio && sourceRadio.checked) sourceRadio.checked = true;
      else if (targetRadio && targetRadio.checked) targetRadio.checked = true;
    }
    return false;
  }
  function handleDragEnd () {
    this.classList.remove('dragging');
    document.querySelectorAll('.option-card-wrapper').forEach(item => { item.classList.remove('drag-over'); });
  }
  function attachDragListeners() {
    document.querySelectorAll('#analysisTypeContent label.option-card-wrapper').forEach(item => {
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('dragenter', handleDragEnter);
      item.addEventListener('dragleave', handleDragLeave);
      item.addEventListener('drop', handleDrop);
      item.addEventListener('dragend', handleDragEnd);
    });
  }

  /* ================================
     âœ… ë²„íŠ¼ ìƒíƒœ + ì‹œê°íš¨ê³¼
  ================================== */
  function setButtonVisualState() {
    [$runBtn,$cancelBtn].forEach(btn=>{
      if (!btn) return;
      if (btn.disabled) btn.classList.add('btn-disabled');
      else btn.classList.remove('btn-disabled');
    });
  }

  function updateButtonState(status, runner) {
    const S = (status || "IDLE").toUpperCase();
    const isRunning = ["START", "IN_PROGRESS", "RUNNING"].includes(S);
    const isOwner = (runner === currentUser);
    globalStatus = S;

    // ì‹¤í–‰ ë²„íŠ¼
    if (!isRunning) {
      $runBtn.disabled = false;
    } else if (isRunning && !isOwner) {
      $runBtn.disabled = true;
    } else if (isRunning && isOwner) {
      $runBtn.disabled = true;
    }

    // ì…ë ¥ í¼
    const inputs = $analysisForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      if (input.id === 'ma20' && input.getAttribute('disabled') !== null) return;
      input.disabled = isRunning;
    });
    toggleMaPeriods();

    // ì·¨ì†Œ ë²„íŠ¼
    $cancelBtn.disabled = !(isRunning && isOwner);
    setButtonVisualState();
  }

  function updateGlobalState(st, runner, progress) {
    const S = (st || "IDLE").toUpperCase();
    let displayText = S;
    if (S === "RUNNING" && runner !== currentUser) {
      displayText = "ë‹¤ë¥¸ ì‚¬ìš©ì ì‹¤í–‰ ì¤‘(ì ê¹€)";
      $globalStatusText.classList.add("status-locked");
    } else {
      $globalStatusText.classList.remove("status-locked");
    }
    $globalStatusText.textContent = displayText;
    $globalRunner.textContent = runner || "ë¯¸ì—°ê²°";

    let pct = 0;
    if (S === "COMPLETED") pct = 100;
    else if (S === "RUNNING") pct = Math.min(100, Math.max(0, Math.floor(progress || 0)));
    else pct = 0;

    $globalProgressLabel.textContent = pct + "%";
    $globalProgressBar.style.width = pct + "%";

    $globalStatusText.className = "";
    if (S === "RUNNING" && runner === currentUser) $globalStatusText.classList.add("status-running", "blinking");
    else if (S === "RUNNING" && runner !== currentUser) $globalStatusText.classList.add("status-locked");
    else if (S === "COMPLETED") $globalStatusText.classList.add("status-completed");
    else if (S === "FAILED") $globalStatusText.classList.add("status-failed");
    else if (S === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
    else $globalStatusText.classList.add("status-idle");
  }

  // âœ… í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
  async function initCurrentUser() {
    try {
      const res = await fetch("/auth/me", { credentials: "include" });
      if (!res.ok) return "-";
      const data = await res.json();
      currentUser = data.username || data.fullName || "-";
      return currentUser;
    } catch {
      currentUser = "-";
      return "-";
    }
  }

  /* ================================
  âœ… ë¡œê·¸
================================== */
function appendLog(line) {
 if (!line) return;
 const p = document.createElement("p");
 // âœ… ìˆ˜ì •: COMPLETED ë¡œê·¸ì˜ ê¸€ì”¨ í¬ê¸°(text-lg)ë¥¼ ì œê±°í•˜ì—¬, ë¶€ëª¨ ìš”ì†Œì˜ text-xsë¥¼ ìƒì†ë°›ì•„ í¬ê¸°ê°€ í†µì¼ë˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.
 if (line.includes("[ERROR]") || line.includes("FATAL") || line.includes("ì‹¤íŒ¨")) {
   p.className = 'text-red-500';
 } else if (line.includes("WARNING")) {
   p.className = 'text-yellow-500';
 } else if (line.includes("COMPLETED") || line.includes("ì„±ê³µ")) {
   p.className = 'text-green-500 font-extrabold'; // text-lg ì œê±°í•˜ì—¬ í¬ê¸° í†µì¼
 } else if (line.includes("[LOG]") || line.includes("ìš”ì²­")) {
   p.className = 'text-blue-400';
 } else {
   p.className = 'text-gray-300';
 }
 p.textContent = line;
 $log.appendChild(p);
 $log.scrollTop = $log.scrollHeight;
}


  /* ================================
     âœ… ë¡œê·¸ ë³µì‚¬
  ================================== */
  $copyLogBtn.onclick = () => {
    const t = Array.from($log.querySelectorAll("p"))
      .map(p => p.textContent)
      .join("\n");
    if (t.trim() === 'ë¡œê·¸ ëŒ€ê¸°ì¤‘...') {
      appendLog("[LOG] ğŸš« ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    navigator.clipboard.writeText(t)
      .then(() => appendLog("[LOG] ğŸ“‹ ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };

  
//ğŸ’¡ íˆ´íŒ í† ê¸€ í•¨ìˆ˜: ì•„ì´ì½˜ í´ë¦­ ì‹œ íˆ´íŒì„ ë³´ì˜€ë‹¤/ìˆ¨ê²¼ë‹¤ í•©ë‹ˆë‹¤.
  window.toggleTooltip = function(event, elementId) {
     // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€: í…Œì´ë¸” í–‰ í´ë¦­ ë“± ë‹¤ë¥¸ ì´ë²¤íŠ¸ê°€ ë™ì‹œì— ë°œìƒí•˜ëŠ” ê²ƒì„ ë§‰ìŠµë‹ˆë‹¤.
     event.stopPropagation(); 
     
     const tooltip = document.getElementById(elementId);
     
     // í˜„ì¬ íˆ´íŒ ìƒíƒœ í† ê¸€
     tooltip.classList.toggle('visible');

     // ë‹¤ë¥¸ íˆ´íŒì´ ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ê¸°
     document.querySelectorAll('.tooltip-box.visible').forEach(box => {
         if (box.id !== elementId) {
             box.classList.remove('visible');
         }
     });
  }

  //ğŸ’¡ íˆ´íŒ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (HTML ë¬¸ì„œ ë¡œë“œ í›„ í•œ ë²ˆë§Œ ì‹¤í–‰)
  document.addEventListener('click', function(event) {
     let isTooltipElement = false;
     
     // í´ë¦­ëœ ìš”ì†Œê°€ íˆ´íŒ ë°•ìŠ¤ ë‚´ë¶€ì´ê±°ë‚˜ ì •ë³´ ì•„ì´ì½˜ì¸ì§€ í™•ì¸
     if (event.target.closest('.tooltip-box') || event.target.classList.contains('info-icon')) {
         isTooltipElement = true;
     }

     // íˆ´íŒ ìš”ì†Œê°€ ì•„ë‹Œ ê³³ì„ í´ë¦­í–ˆë‹¤ë©´ ëª¨ë“  íˆ´íŒì„ ë‹«ìŠµë‹ˆë‹¤.
     if (!isTooltipElement) {
         document.querySelectorAll('.tooltip-box.visible').forEach(box => {
             box.classList.remove('visible');
         });
     }
  });

/* ================================
  2. ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ (renderResults)
  ================================ */
function renderResults(list) {
   const $resultTableBody = document.getElementById("resultTableBody");
   const $noResultBox = document.getElementById("noResultBox");
   
   $resultTableBody.innerHTML = "";
   if (!list || list.length === 0) {
       $noResultBox.classList.remove("hidden");
       return;
   }
   $noResultBox.classList.add("hidden");

   list.forEach((item, index) => {
       const rowId = `result-row-${item.ticker}`;
       const tr = document.createElement("tr");
       const initialClasses = 'hover:bg-gray-100 transition duration-100'; 
       tr.className = initialClasses;

       // ğŸ’¡ í¬ë¡œìŠ¤ ì—¬ë¶€ íŒë³„ ë° ë±ƒì§€ ìƒì„± ë¡œì§
       const conditions = item.technical_conditions || {};
       let crossBadge = '<span>-</span>';
       
       if (conditions.goldencross_50_200_detected) {
           crossBadge = `<span class="bg-red-500 text-white text-xs font-medium px-2 py-1 rounded-full">â­ ê³¨ë“  í¬ë¡œìŠ¤</span>`;
       } else if (conditions.deadcross_50_200_detected) {
           crossBadge = `<span class="bg-blue-500 text-white text-xs font-medium px-2 py-1 rounded-full">ğŸ’€ ë°ë“œ í¬ë¡œìŠ¤</span>`;
       }

       // ğŸ’¡ MA ë°°ì—´ ìƒíƒœ (down_trend_status) ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
       const maStatus = conditions.down_trend_status || "-";
       
       // MA ë°°ì—´ ìƒíƒœì— ë”°ë¥¸ ë±ƒì§€ ì‹œê°í™”
       let maStatusContent = maStatus;
       if (maStatus === 'StrongDownTrend') {
           maStatusContent = `<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">${maStatus}</span>`;
       }


       // --- íˆ´íŒ ì„¤ëª… ì •ì˜ ---
       const tooltip_rank = `ì „ì²´ ë¶„ì„ ì¢…ëª© ì¤‘ Market Regime(ì‹œì¥ êµ­ë©´)ì„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ëœ ìˆœìœ„ì…ë‹ˆë‹¤.`;
       const tooltip_signal = `K-Means í´ëŸ¬ìŠ¤í„°ë§ì„ í†µí•´ ë¶„ë¥˜ëœ ì‹œì¥ êµ­ë©´(Market Regime) ë²ˆí˜¸(0~3)ì…ë‹ˆë‹¤. ì´ ìˆ«ìê°€ í´ìˆ˜ë¡ ì •ë ¬ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤.`;
       const tooltip_ma_array = `ì¥ê¸° í•˜ë½ ì¶”ì„¸(StrongDownTrend) ì—¬ë¶€ ë° MA ë°°ì—´ ìƒíƒœ (MA20 < MA50 < MA200 ì¡°ê±´ í¬í•¨)ì…ë‹ˆë‹¤.`;
       const tooltip_cross = `50ì¼ ì´ë™í‰ê· ì„ ê³¼ 200ì¼ ì´ë™í‰ê· ì„ ì˜ ìµœê·¼ í•˜ë£¨ ë™ì•ˆì˜ êµì°¨ ë°œìƒ ì—¬ë¶€ì…ë‹ˆë‹¤.`;
       // ------------------------
       
       // ğŸ’¡ ê³ ìœ  ID ìƒì„± (íˆ´íŒ ë°•ìŠ¤ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•¨)
       const rankId = `tt-rank-${item.ticker}`;
       const signalId = `tt-signal-${item.ticker}`;
       const maId = `tt-ma-${item.ticker}`;
       const crossId = `tt-cross-${item.ticker}`;


       tr.innerHTML = `
           <td class="px-4 py-2 border font-bold">
               <div class="flex items-center justify-start">
                   ${index + 1}
                   <div class="tooltip-container">
                       <span class="info-icon" onclick="toggleTooltip(event, '${rankId}')">i</span>
                       <div id="${rankId}" class="tooltip-box">${tooltip_rank}</div>
                   </div>
               </div>
           </td>
           <td class="px-4 py-2 border">${item.ticker || "-"}</td>
           <td class="px-4 py-2 border">${item.name || "-"}</td>
           <td class="px-4 py-2 border font-bold">
               <div class="flex items-center justify-center">
                   ${item.technical_conditions?.market_regime || "-"}
                   <div class="tooltip-container">
                       <span class="info-icon" onclick="toggleTooltip(event, '${signalId}')">i</span>
                       <div id="${signalId}" class="tooltip-box">${tooltip_signal}</div>
                   </div>
               </div>
           </td>
           <td class="px-4 py-2 border">
               <div class="flex items-center justify-start">
                   ${maStatusContent}
                   <div class="tooltip-container">
                       <span class="info-icon" onclick="toggleTooltip(event, '${maId}')">i</span>
                       <div id="${maId}" class="tooltip-box">${tooltip_ma_array}</div>
                   </div>
               </div>
           </td>
           <td class="px-4 py-2 border text-center">
               <div class="flex items-center justify-center">
                   ${crossBadge}
                   <div class="tooltip-container">
                       <span class="info-icon" onclick="toggleTooltip(event, '${crossId}')">i</span>
                       <div id="${crossId}" class="tooltip-box">${tooltip_cross}</div>
                   </div>
               </div>
           </td>
           <td class="px-4 py-2 border text-center">
               <button class="px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                       onclick="showChart('${item.ticker}', '${item.name}', '${rowId}')">ë³´ê¸°</button>
           </td>
       `;
       $resultTableBody.appendChild(tr);
   });

    appendLog(`[LOG] âœ… ìµœì¢… ë¶„ì„ ê²°ê³¼ ${list.length}ê°œ í•­ëª© í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ.`);
  }

  /* ================================
     âœ… ì°¨íŠ¸ ìœ í‹¸
  ================================== */
  function destroyCharts() {
    try { if (priceChart) { priceChart.destroy(); priceChart = null; } } catch(e){}
    try { if (macdChart)  { macdChart.destroy();  macdChart  = null; } } catch(e){}
    if ($btnResetZoom) $btnResetZoom.classList.add('hidden');
    if ($btnSaveChart) $btnSaveChart.classList.add('hidden');
  }

  function toXY(ds) {
    if (!Array.isArray(ds)) return [];
    return ds.map(d => {
      const timestamp = new Date(d.x).getTime();
      if (isNaN(timestamp) || d.y === null || d.y === undefined || isNaN(d.y)) return null;
      return { x: timestamp, y: d.y };
    }).filter(p => p !== null);
  }

  /* ============================================================
   * ğŸ“ˆ buildPriceChart (Candlestick Chart - ì•ˆì •íŒ v3.2)
   * ------------------------------------------------------------
   * âœ… Chart.js Financial + chartjs-plugin-zoom + Hammer.js í˜¸í™˜
   * âœ… ì¤Œ/ì´ë™ ì‹œ ë°ì´í„° ì‚¬ë¼ì§ ë°©ì§€ (ë²”ìœ„ ê³ ì •)
   * âœ… ì¢Œìš° ì´ë™/í™•ëŒ€ ì•ˆì •í™” + Yì¶• ìë™ ìŠ¤ì¼€ì¼ë§
   * âœ… ë¶€ë“œëŸ¬ìš´ ë“œë˜ê·¸(íŒ¬) + íœ  ì¤Œ + í„°ì¹˜ ì¤Œ ì™„ë²½ ì‘ë™
   * ============================================================ */
  function buildPriceChart(ctx, payload) {
    const ohlcData = payload.ohlcv_data
      ? payload.ohlcv_data.map(d => {
          const ts = new Date(d.x).getTime();
          if (isNaN(ts) || d.o===undefined || d.h===undefined || d.l===undefined || d.c===undefined) return null;
          return { x: ts, o: d.o, h: d.h, l: d.l, c: d.c };
        }).filter(Boolean)
      : [];

    const ma20  = payload.ma_data?.MA20  ? toXY(payload.ma_data.MA20)  : [];
    const ma50  = payload.ma_data?.MA50  ? toXY(payload.ma_data.MA50)  : [];
    const ma200 = payload.ma_data?.MA200 ? toXY(payload.ma_data.MA200) : [];

    const cross = Array.isArray(payload.cross_points)
      ? payload.cross_points.map(p => {
          const ts = new Date(p.x).getTime();
          if (isNaN(ts)) return null;
          return {x:ts, y:p.y, type:p.type};
        }).filter(Boolean)
      : [];

    const pats = Array.isArray(payload.pattern_points)
      ? payload.pattern_points.map(p => {
          const ts = new Date(p.x).getTime();
          if (isNaN(ts)) return null;
          return {x:ts, y:p.y, type:p.type, status:p.status};
        }).filter(Boolean)
      : [];

    // âœ… ì „ì²´ ë°ì´í„°ì˜ x ë²”ìœ„ ê³„ì‚° (ì´ë™ í•œê³„ ì„¤ì •ìš©)
    const xMin = ohlcData.length ? ohlcData[0].x : undefined;
    const xMax = ohlcData.length ? ohlcData[ohlcData.length - 1].x : undefined;

    priceChart = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [
          { label: 'OHLCV', data: ohlcData, parsing:false, borderWidth:1.3 },
          { type:'line', label:'MA20',  data:ma20,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#22c55e' },
          { type:'line', label:'MA50',  data:ma50,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#7c3aed' },
          { type:'line', label:'MA200', data:ma200, parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#3b82f6' },
          { label:'Cross', type:'scatter', data:cross, parsing:false, pointRadius:4, pointBackgroundColor:'#ef4444' },
          { label:'Pattern', type:'scatter', data:pats, parsing:false, pointRadius:4, pointBackgroundColor:'#8b5cf6' }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          x:{
            type:'time',
            time:{ tooltipFormat:'yyyy-MM-dd' },
            grid:{ display:false },
            min: xMin,
            max: xMax
          },
          y:{
            beginAtZero:false,
            ticks:{ callback:v => v.toLocaleString() }
          }
        },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ enabled:true },
          zoom:{
            pan:{
              enabled:true,
              mode:'x',
              // âœ… ë°ì´í„° ë²”ìœ„ ë°– ì´ë™ ë°©ì§€
              onPan: ({chart}) => {
                const xScale = chart.scales.x;
                const {min, max} = xScale;
                const dataMin = xMin;
                const dataMax = xMax;
                if (min < dataMin) xScale.options.min = dataMin;
                if (max > dataMax) xScale.options.max = dataMax;
              },
            },
            zoom:{
              wheel:{ enabled:true },
              pinch:{ enabled:true },
              mode:'x',
              // âœ… ê³¼ë„í•œ í™•ëŒ€ ì‹œ ìë™ ë³µì›
              onZoom: ({chart}) => {
                const xScale = chart.scales.x;
                const range = xScale.max - xScale.min;
                const fullRange = xMax - xMin;
                if (range < fullRange * 0.01) chart.resetZoom();
              },
            },
          }
        }
      }
    });
  }


  function buildMacdChart(ctx, payload) {
    const macd   = payload.macd_data?.MACD      ? toXY(payload.macd_data.MACD)      : [];
    const signal = payload.macd_data?.Signal    ? toXY(payload.macd_data.Signal)    : [];
    const hist   = payload.macd_data?.Histogram ? toXY(payload.macd_data.Histogram) : [];

    macdChart = new Chart(ctx, {
      data: {
        datasets: [
          { type:'line', label:'MACD',   data: macd,   parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#111827' },
          { type:'line', label:'Signal', data: signal, parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#f43f5e' },
          {
            type:'bar',
            label:'Hist',
            data: hist,
            parsing:false,
            backgroundColor: (ctx) => {
              const value = ctx.parsed.y;
              return value > 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)';
            },
          }
        ].filter(ds => ds.data?.length > 0 || ds.type !== 'line')
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          x:{ type:'time', time:{ tooltipFormat:'yyyy-MM-dd' }, grid:{ display:false } },
          y:{ beginAtZero:false }
        },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ enabled:true },
          zoom:{
        	  pan:{ enabled:true, mode:'xy' }, // âœ… ìœ„ì•„ë˜/ì¢Œìš° ì´ë™
              zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' } // âœ… ìœ„ì•„ë˜/ì¢Œìš° í™•ëŒ€/ì¶•ì†Œ
          }
        }
      }
    });
  }

  /* ==========================================================
     âœ… JSON ì°¨íŠ¸ ìš”ì²­ (ì»¨íŠ¸ë¡¤ëŸ¬ ì‹œê·¸ë‹ˆì²˜ì™€ ì¼ì¹˜)
  ========================================================== */
  async function tryRenderChartsByJson(ticker, name){
    const url = `/api/stock/batch/athena/chart?symbol=${encodeURIComponent(ticker)}&ts=${Date.now()}`;
    const res = await fetch(url, { headers: { 'Accept':'application/json' } });
    const ct = res.headers.get('Content-Type') || '';
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    if (!ct.includes('application/json')) throw new Error('Not JSON. Server returned: ' + ct);

    const payload = await res.json();

    destroyCharts();

    // ë°©ì–´: ìº”ë²„ìŠ¤ê°€ ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•¨
    if (!$priceCanvas || !$macdCanvas) {
      throw new Error('ì°¨íŠ¸ ìº”ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    buildPriceChart($priceCanvas.getContext('2d'), payload);
    buildMacdChart($macdCanvas.getContext('2d'), payload);

    // ë²„íŠ¼ í™œì„±í™”
    if ($btnResetZoom) $btnResetZoom.classList.remove('hidden');
    if ($btnSaveChart) $btnSaveChart.classList.remove('hidden');

    // âœ… ì¤Œ ì´ˆê¸°í™”
    if ($btnResetZoom) {
      $btnResetZoom.onclick = () => {
        try { priceChart?.resetZoom?.(); } catch(e){}
        try { macdChart?.resetZoom?.(); } catch(e){}
      };
    }

    // âœ… ì´ë¯¸ì§€ ì €ì¥ (ë©”ì¸ + MACD í•©ì„± í›„ PNG ë‹¤ìš´ë¡œë“œ)
    if ($btnSaveChart) {
      $btnSaveChart.onclick = () => {
        try {
          // ì‹¤ì œ ë Œë”ë§ í¬ê¸° í™•ë³´
          const c1 = $priceCanvas;
          const c2 = $macdCanvas;

          // Retina ëŒ€ë¹„: ë‚´ë¶€ í”½ì…€ í¬ê¸°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ â†’ toDataURL ì „ ê·¸ëŒ€ë¡œ í•©ì„±
          const merged = document.createElement('canvas');
          merged.width  = Math.max(c1.width, c2.width);
          merged.height = c1.height + c2.height + 20;

          const ctx = merged.getContext('2d');
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, merged.width, merged.height);
          ctx.drawImage(c1, 0, 0);
          ctx.drawImage(c2, 0, c1.height + 10);

          const link = document.createElement('a');
          link.download = `${ticker}_${name}_chart.png`;
          link.href = merged.toDataURL('image/png');
          link.click();

          appendLog(`[LOG] ğŸ’¾ ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ (${ticker})`);
        } catch (e) {
          appendLog(`[ERROR] ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
        }
      };
    }

    appendLog(`[LOG] ğŸ“ˆ ì°¨íŠ¸ ë°ì´í„°(JSON) ë¡œë“œ ì™„ë£Œ: ${ticker} - ${name}`);
  }

  /* ==========================================================
     âœ… ì°¨íŠ¸ ëª¨ë‹¬ (ë¡œë”© ìŠ¤í”¼ë„ˆ + ë¦¬ì‚¬ì´ì¦ˆ ì•ˆì •í™”)
  ========================================================== */
  let modalResizeObserver = null;

  /* âœ… ì°¨íŠ¸ ëª¨ë‹¬ ì—´ê¸° (body scroll lock í¬í•¨) */
  window.showChart = async (ticker, name, rowId) => {
    if (!$chartModal) return;
    $modalTitle.textContent = `ğŸ“ˆ ${ticker} - ${name}`;
    $chartModal.classList.remove("hidden");
    
    // â­ ëª¨ë°”ì¼ ëŒ€ì‘ ìˆ˜ì •: bodyì— scroll lock í´ë˜ìŠ¤ ì¶”ê°€
    document.body.classList.add('modal-open-fix');
    
    // ğŸš€ ìŠ¤í”¼ë„ˆ ë°”ë¡œ í‘œì‹œ í›„ ì°¨íŠ¸ ë¡œë“œ (ì§€ì—° ì‹¤í–‰)
    $chartLoading.classList.remove('hidden');
    await new Promise(r => setTimeout(r, 100));  // ì‚´ì§ ë”œë ˆì´ ì£¼ë©´ ì‹œê°ì  ë°˜ì‘ ì™„ë²½í•¨

    try {
      await tryRenderChartsByJson(ticker, name);
    } catch (err) {
      destroyCharts();
      if ($btnResetZoom) $btnResetZoom.classList.add('hidden');
      if ($btnSaveChart)  $btnSaveChart.classList.add('hidden');
      appendLog(`[LOG] â„¹ï¸ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
    } finally {
      $chartLoading.classList.add('hidden');
    }

    if (modalResizeObserver) modalResizeObserver.disconnect();
    const modalCard = $chartModal.querySelector('.bg-white.rounded-xl');
    if (modalCard) {
      modalResizeObserver = new ResizeObserver(() => {
        try { priceChart?.resize(); macdChart?.resize(); } catch {}
      });
      modalResizeObserver.observe(modalCard);
    }
  };

  // ----------------------------------------------------

  /* âœ… ì°¨íŠ¸ ëª¨ë‹¬ ë‹«ê¸° (body scroll ë³µì›) */
  window.closeChartModal = () => {
    try { modalResizeObserver?.disconnect(); } catch {}
    modalResizeObserver = null;
    if ($chartModal) $chartModal.classList.add("hidden");
    destroyCharts();
    
    // â­ ëª¨ë°”ì¼ ëŒ€ì‘ ìˆ˜ì •: bodyì—ì„œ scroll lock í´ë˜ìŠ¤ ì œê±°í•˜ì—¬ ìŠ¤í¬ë¡¤ ë³µì›
    document.body.classList.remove('modal-open-fix');
  };

  // âœ… ìˆ˜ë™ ê²€í†  ì™„ë£Œ (í˜„ì¬ í…Œì´ë¸” í–‰ì— ë°°ì§€ í‘œì‹œ)
  window.updateResultStatus = function() {
    if ($currentRow) {
      const scoreCell = $currentRow.cells[2];
      const ticker = $currentRow.cells[0].textContent;
      const originalContent = scoreCell.textContent.replace('â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ', '').trim();
      if (scoreCell.innerHTML.includes('ìˆ˜ë™ ê²€í†  ì™„ë£Œ')) {
        appendLog(`[UPDATE] ${ticker} ì¢…ëª©ì€ ì´ë¯¸ ê²€í†  ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        closeChartModal();
        return;
      }
      scoreCell.innerHTML = `
        <span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">
          â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ
        </span>
        ${originalContent}
      `;
      $currentRow.classList.add('bg-green-50');
      $currentRow.classList.remove('hover:bg-gray-100');
      $currentRow.classList.add('transition-colors', 'duration-500');
      appendLog(`[UPDATE] ${ticker} ì¢…ëª© ìˆ˜ë™ ê²€í†  ì™„ë£Œ.`);
    }
    closeChartModal();
  };

  /* ================================
     âœ… SSE
  ================================== */
  function connectSSE() {
    if (es) { try { es.close(); } catch {} }
    appendLog(`[LOG] SSE ì—°ê²° ì‹œë„. í˜„ì¬ ì‚¬ìš©ì ID: ${currentUser}`);
    es = new EventSource("/api/stock/batch/athena/sse");

    es.onopen = () => { appendLog("[LOG] SSE ì—°ê²° ì„±ê³µ."); };

    es.addEventListener("status", (ev) => {
      const d = JSON.parse(ev.data || "{}");
      if (d.globalStatus) {
        updateGlobalState(d.globalStatus, d.globalRunner, d.globalProgress);
        updateButtonState(d.globalStatus, d.globalRunner);
      }
      if (Array.isArray(d.logs)) d.logs.forEach(line => appendLog(line));
      if (Array.isArray(d.results)) renderResults(d.results);
      if (d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = () => {
      appendLog("[ERROR] SSE ì—°ê²° ì˜¤ë¥˜. ì¬ì‹œë„ ì¤‘...");
      try { es.close(); } catch {}
      es = null;
      updateButtonState("IDLE", currentUser);
      setTimeout(connectSSE, 2000);
    };
  }

  /* ================================
     âœ… ë¶„ì„ ì‹¤í–‰
  ================================== */
  window.runAnalysis = async () => {
    if ($runBtn.disabled) {
      if (globalStatus === 'RUNNING' && $globalRunner.textContent !== currentUser) {
        appendLog("[ERROR] ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‹¤í–‰ ì¤‘. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
      } else {
        appendLog("[ERROR] í˜„ì¬ ì‹¤í–‰ ë¶ˆê°€ ìƒíƒœ.");
      }
      return;
    }
    updateButtonState("RUNNING", currentUser);
    $log.innerHTML = `<p class="opacity-70">ë¶„ì„ ìš”ì²­ ì‹œì‘...</p>`;
    $resultTableBody.innerHTML = "";
    $noResultBox.classList.add("hidden");

    const pattern = getSelectedPattern();
    const workers = document.getElementById("workerCount").value;
    const topN = document.getElementById("topNCount").value;
    const maPeriods = getMaPeriods();

    const url = `/api/stock/batch/athena/start`
      + `?pattern=${encodeURIComponent(pattern)}`
      + `&workers=${encodeURIComponent(workers)}`
      + `&maPeriods=${encodeURIComponent(maPeriods)}`
      + `&topN=${encodeURIComponent(topN)}`;

    try {
      const res = await fetch(url, { method: 'POST' });
      if (!res.ok) {
        const errorText = await res.text();
        appendLog(`[ERROR] ë¶„ì„ ì‹œì‘ ìš”ì²­ ì‹¤íŒ¨: ${res.status} ${errorText}`);
        updateButtonState("IDLE", currentUser);
      } else {
        const data = await res.json();
        currentTaskId = data.taskId;
        appendLog(`[LOG] ë¶„ì„ ì‹œì‘ ìš”ì²­ ì„±ê³µ. Task ID: ${currentTaskId}`);
      }
    } catch (error) {
      appendLog(`[FATAL] ë¶„ì„ ì‹œì‘ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
      updateButtonState("IDLE", currentUser);
    }
  };

  /* ================================
     âœ… ë¶„ì„ ì·¨ì†Œ (PathVar â†’ ì‹¤íŒ¨ ì‹œ QueryParam í´ë°±)
  ================================== */
  async function postCancel(taskId){
    let r = await fetch(`/api/stock/batch/athena/cancel/${encodeURIComponent(taskId)}`, { method:'POST' });
    if (r.ok) return r;
    return fetch(`/api/stock/batch/athena/cancel?taskId=${encodeURIComponent(taskId)}`, { method:'POST' });
  }

  window.cancelAnalysis = async () => {
    if (!currentTaskId || $cancelBtn.disabled) {
      appendLog("[WARNING] ì·¨ì†Œí•  í™œì„± ì‘ì—…ì´ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    try {
      const res = await postCancel(currentTaskId);
      if (res.ok) {
        appendLog(`[LOG] Task ID ${currentTaskId} ì·¨ì†Œ ìš”ì²­ ì„±ê³µ.`);
      } else {
        const errorText = await res.text();
        appendLog(`[ERROR] ë¶„ì„ ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨: ${res.status} ${errorText}`);
      }
    } catch (error) {
      appendLog(`[FATAL] ë¶„ì„ ì·¨ì†Œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
    }
  };

  /* ================================
     âœ… ì´ˆê¸°í™”
  ================================== */
  document.addEventListener("DOMContentLoaded", () => {
    attachDragListeners();
    toggleMaPeriods();
    initCurrentUser().then(() => { connectSSE(); setButtonVisualState(); });
  });

})();
</script>
</th:block>


</body>
</html>
